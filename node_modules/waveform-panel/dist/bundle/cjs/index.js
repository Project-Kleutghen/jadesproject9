"use strict";var t=Object.defineProperty,e=(e,s,i)=>(((e,s,i)=>{s in e?t(e,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[s]=i})(e,"symbol"!=typeof s?s+"":s,i),i);Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const s=t=>{let e;const s=new Set,i=(t,i)=>{const n="function"==typeof t?t(e):t;if(!Object.is(n,e)){const t=e;e=(null!=i?i:"object"!=typeof n)?n:Object.assign({},e,n),s.forEach((s=>s(e,t)))}},n=()=>e,a={setState:i,getState:n,subscribe:t=>(s.add(t),()=>s.delete(t)),destroy:()=>s.clear()};return e=t(i,n,a),a};function i(t,e){const s=(t||"").replace(/\n/,"").trim();return void 0!==e?s.split(e):s}function n(t,e){this._waveformData=t,this._channelIndex=e}n.prototype.min_sample=function(t){var e=2*(t*this._waveformData.channels+this._channelIndex);return this._waveformData._at(e)},n.prototype.max_sample=function(t){var e=2*(t*this._waveformData.channels+this._channelIndex)+1;return this._waveformData._at(e)},n.prototype.set_min_sample=function(t,e){var s=2*(t*this._waveformData.channels+this._channelIndex);return this._waveformData._set_at(s,e)},n.prototype.set_max_sample=function(t,e){var s=2*(t*this._waveformData.channels+this._channelIndex)+1;return this._waveformData._set_at(s,e)},n.prototype.min_array=function(){return this._waveformData._offsetValues(0,this._waveformData.length,2*this._channelIndex)},n.prototype.max_array=function(){return this._waveformData._offsetValues(0,this._waveformData.length,2*this._channelIndex+1)};var a=127,r=-128;function o(t){var e,s,i=t.scale,n=t.amplitude_scale,o=t.split_channels,h=t.length,g=t.sample_rate,l=t.channels.map((function(t){return new Float32Array(t)})),u=o?l.length:1,c=1===u?1:2,d=1===c?20:24,m=function(t,e){var s=Math.floor(t/e);return t-s*e>0&&s++,s}(h,i),f=new ArrayBuffer(d+2*m*u),I=new DataView(f),b=0,p=d,v=new Array(u),A=new Array(u);for(e=0;e<u;e++)v[e]=1/0,A[e]=-1/0;for(I.setInt32(0,c,!0),I.setUint32(4,1,!0),I.setInt32(8,g,!0),I.setInt32(12,i,!0),I.setInt32(16,m,!0),2===c&&I.setInt32(20,u,!0),s=0;s<h;s++){var C=0;if(1===u){for(e=0;e<l.length;++e)C+=l[e][s];(C=Math.floor(a*C*n/l.length))<v[0]&&(v[0]=C,v[0]<r&&(v[0]=r)),C>A[0]&&(A[0]=C,A[0]>a&&(A[0]=a))}else for(e=0;e<u;++e)(C=Math.floor(a*l[e][s]*n))<v[e]&&(v[e]=C,v[e]<r&&(v[e]=r)),C>A[e]&&(A[e]=C,A[e]>a&&(A[e]=a));if(++b===i){for(e=0;e<u;e++)I.setInt8(p++,v[e]),I.setInt8(p++,A[e]),v[e]=1/0,A[e]=-1/0;b=0}}if(b>0)for(e=0;e<u;e++)I.setInt8(p++,v[e]),I.setInt8(p++,A[e]);return f}function h(t){return(h="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function g(t,e,s){var i=void 0===e?null:e,n=function(t,e){var s=atob(t);if(e){for(var i=new Uint8Array(s.length),n=0,a=s.length;n<a;++n)i[n]=s.charCodeAt(n);return String.fromCharCode.apply(null,new Uint16Array(i.buffer))}return s}(t,void 0!==s&&s),a=n.indexOf("\n",10)+1,r=n.substring(a)+(i?"//# sourceMappingURL="+i:""),o=new Blob([r],{type:"application/javascript"});return URL.createObjectURL(o)}var l,u,c,d,m=(l="Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwooZnVuY3Rpb24gKCkgewogICd1c2Ugc3RyaWN0JzsKCiAgLyoqCiAgICogQXVkaW9CdWZmZXItYmFzZWQgV2F2ZWZvcm1EYXRhIGdlbmVyYXRvcgogICAqCiAgICogQWRhcHRlZCBmcm9tIEJsb2NrRmlsZTo6Q2FsY1N1bW1hcnkgaW4gQXVkYWNpdHksIHdpdGggcGVybWlzc2lvbi4KICAgKiBTZWUgaHR0cHM6Ly9jb2RlLmdvb2dsZS5jb20vcC9hdWRhY2l0eS9zb3VyY2UvYnJvd3NlL2F1ZGFjaXR5LXNyYy90cnVuay9zcmMvQmxvY2tGaWxlLmNwcAogICAqLwogIHZhciBJTlQ4X01BWCA9IDEyNzsKICB2YXIgSU5UOF9NSU4gPSAtMTI4OwoKICBmdW5jdGlvbiBjYWxjdWxhdGVXYXZlZm9ybURhdGFMZW5ndGgoYXVkaW9fc2FtcGxlX2NvdW50LCBzY2FsZSkgewogICAgdmFyIGRhdGFfbGVuZ3RoID0gTWF0aC5mbG9vcihhdWRpb19zYW1wbGVfY291bnQgLyBzY2FsZSk7CiAgICB2YXIgc2FtcGxlc19yZW1haW5pbmcgPSBhdWRpb19zYW1wbGVfY291bnQgLSBkYXRhX2xlbmd0aCAqIHNjYWxlOwoKICAgIGlmIChzYW1wbGVzX3JlbWFpbmluZyA+IDApIHsKICAgICAgZGF0YV9sZW5ndGgrKzsKICAgIH0KCiAgICByZXR1cm4gZGF0YV9sZW5ndGg7CiAgfQoKICBmdW5jdGlvbiBnZW5lcmF0ZVdhdmVmb3JtRGF0YShvcHRpb25zKSB7CiAgICB2YXIgc2NhbGUgPSBvcHRpb25zLnNjYWxlOwogICAgdmFyIGFtcGxpdHVkZV9zY2FsZSA9IG9wdGlvbnMuYW1wbGl0dWRlX3NjYWxlOwogICAgdmFyIHNwbGl0X2NoYW5uZWxzID0gb3B0aW9ucy5zcGxpdF9jaGFubmVsczsKICAgIHZhciBsZW5ndGggPSBvcHRpb25zLmxlbmd0aDsKICAgIHZhciBzYW1wbGVfcmF0ZSA9IG9wdGlvbnMuc2FtcGxlX3JhdGU7CiAgICB2YXIgY2hhbm5lbHMgPSBvcHRpb25zLmNoYW5uZWxzLm1hcChmdW5jdGlvbiAoY2hhbm5lbCkgewogICAgICByZXR1cm4gbmV3IEZsb2F0MzJBcnJheShjaGFubmVsKTsKICAgIH0pOwogICAgdmFyIG91dHB1dF9jaGFubmVscyA9IHNwbGl0X2NoYW5uZWxzID8gY2hhbm5lbHMubGVuZ3RoIDogMTsKICAgIHZhciB2ZXJzaW9uID0gb3V0cHV0X2NoYW5uZWxzID09PSAxID8gMSA6IDI7CiAgICB2YXIgaGVhZGVyX3NpemUgPSB2ZXJzaW9uID09PSAxID8gMjAgOiAyNDsKICAgIHZhciBkYXRhX2xlbmd0aCA9IGNhbGN1bGF0ZVdhdmVmb3JtRGF0YUxlbmd0aChsZW5ndGgsIHNjYWxlKTsKICAgIHZhciB0b3RhbF9zaXplID0gaGVhZGVyX3NpemUgKyBkYXRhX2xlbmd0aCAqIDIgKiBvdXRwdXRfY2hhbm5lbHM7CiAgICB2YXIgYnVmZmVyID0gbmV3IEFycmF5QnVmZmVyKHRvdGFsX3NpemUpOwogICAgdmFyIGRhdGFfdmlldyA9IG5ldyBEYXRhVmlldyhidWZmZXIpOwogICAgdmFyIHNjYWxlX2NvdW50ZXIgPSAwOwogICAgdmFyIG9mZnNldCA9IGhlYWRlcl9zaXplOwogICAgdmFyIGNoYW5uZWwsIGk7CiAgICB2YXIgbWluX3ZhbHVlID0gbmV3IEFycmF5KG91dHB1dF9jaGFubmVscyk7CiAgICB2YXIgbWF4X3ZhbHVlID0gbmV3IEFycmF5KG91dHB1dF9jaGFubmVscyk7CgogICAgZm9yIChjaGFubmVsID0gMDsgY2hhbm5lbCA8IG91dHB1dF9jaGFubmVsczsgY2hhbm5lbCsrKSB7CiAgICAgIG1pbl92YWx1ZVtjaGFubmVsXSA9IEluZmluaXR5OwogICAgICBtYXhfdmFsdWVbY2hhbm5lbF0gPSAtSW5maW5pdHk7CiAgICB9CgogICAgZGF0YV92aWV3LnNldEludDMyKDAsIHZlcnNpb24sIHRydWUpOyAvLyBWZXJzaW9uCgogICAgZGF0YV92aWV3LnNldFVpbnQzMig0LCAxLCB0cnVlKTsgLy8gSXMgOCBiaXQ/CgogICAgZGF0YV92aWV3LnNldEludDMyKDgsIHNhbXBsZV9yYXRlLCB0cnVlKTsgLy8gU2FtcGxlIHJhdGUKCiAgICBkYXRhX3ZpZXcuc2V0SW50MzIoMTIsIHNjYWxlLCB0cnVlKTsgLy8gU2NhbGUKCiAgICBkYXRhX3ZpZXcuc2V0SW50MzIoMTYsIGRhdGFfbGVuZ3RoLCB0cnVlKTsgLy8gTGVuZ3RoCgogICAgaWYgKHZlcnNpb24gPT09IDIpIHsKICAgICAgZGF0YV92aWV3LnNldEludDMyKDIwLCBvdXRwdXRfY2hhbm5lbHMsIHRydWUpOwogICAgfQoKICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICB2YXIgc2FtcGxlID0gMDsKCiAgICAgIGlmIChvdXRwdXRfY2hhbm5lbHMgPT09IDEpIHsKICAgICAgICBmb3IgKGNoYW5uZWwgPSAwOyBjaGFubmVsIDwgY2hhbm5lbHMubGVuZ3RoOyArK2NoYW5uZWwpIHsKICAgICAgICAgIHNhbXBsZSArPSBjaGFubmVsc1tjaGFubmVsXVtpXTsKICAgICAgICB9CgogICAgICAgIHNhbXBsZSA9IE1hdGguZmxvb3IoSU5UOF9NQVggKiBzYW1wbGUgKiBhbXBsaXR1ZGVfc2NhbGUgLyBjaGFubmVscy5sZW5ndGgpOwoKICAgICAgICBpZiAoc2FtcGxlIDwgbWluX3ZhbHVlWzBdKSB7CiAgICAgICAgICBtaW5fdmFsdWVbMF0gPSBzYW1wbGU7CgogICAgICAgICAgaWYgKG1pbl92YWx1ZVswXSA8IElOVDhfTUlOKSB7CiAgICAgICAgICAgIG1pbl92YWx1ZVswXSA9IElOVDhfTUlOOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHNhbXBsZSA+IG1heF92YWx1ZVswXSkgewogICAgICAgICAgbWF4X3ZhbHVlWzBdID0gc2FtcGxlOwoKICAgICAgICAgIGlmIChtYXhfdmFsdWVbMF0gPiBJTlQ4X01BWCkgewogICAgICAgICAgICBtYXhfdmFsdWVbMF0gPSBJTlQ4X01BWDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yIChjaGFubmVsID0gMDsgY2hhbm5lbCA8IG91dHB1dF9jaGFubmVsczsgKytjaGFubmVsKSB7CiAgICAgICAgICBzYW1wbGUgPSBNYXRoLmZsb29yKElOVDhfTUFYICogY2hhbm5lbHNbY2hhbm5lbF1baV0gKiBhbXBsaXR1ZGVfc2NhbGUpOwoKICAgICAgICAgIGlmIChzYW1wbGUgPCBtaW5fdmFsdWVbY2hhbm5lbF0pIHsKICAgICAgICAgICAgbWluX3ZhbHVlW2NoYW5uZWxdID0gc2FtcGxlOwoKICAgICAgICAgICAgaWYgKG1pbl92YWx1ZVtjaGFubmVsXSA8IElOVDhfTUlOKSB7CiAgICAgICAgICAgICAgbWluX3ZhbHVlW2NoYW5uZWxdID0gSU5UOF9NSU47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoc2FtcGxlID4gbWF4X3ZhbHVlW2NoYW5uZWxdKSB7CiAgICAgICAgICAgIG1heF92YWx1ZVtjaGFubmVsXSA9IHNhbXBsZTsKCiAgICAgICAgICAgIGlmIChtYXhfdmFsdWVbY2hhbm5lbF0gPiBJTlQ4X01BWCkgewogICAgICAgICAgICAgIG1heF92YWx1ZVtjaGFubmVsXSA9IElOVDhfTUFYOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoKytzY2FsZV9jb3VudGVyID09PSBzY2FsZSkgewogICAgICAgIGZvciAoY2hhbm5lbCA9IDA7IGNoYW5uZWwgPCBvdXRwdXRfY2hhbm5lbHM7IGNoYW5uZWwrKykgewogICAgICAgICAgZGF0YV92aWV3LnNldEludDgob2Zmc2V0KyssIG1pbl92YWx1ZVtjaGFubmVsXSk7CiAgICAgICAgICBkYXRhX3ZpZXcuc2V0SW50OChvZmZzZXQrKywgbWF4X3ZhbHVlW2NoYW5uZWxdKTsKICAgICAgICAgIG1pbl92YWx1ZVtjaGFubmVsXSA9IEluZmluaXR5OwogICAgICAgICAgbWF4X3ZhbHVlW2NoYW5uZWxdID0gLUluZmluaXR5OwogICAgICAgIH0KCiAgICAgICAgc2NhbGVfY291bnRlciA9IDA7CiAgICAgIH0KICAgIH0KCiAgICBpZiAoc2NhbGVfY291bnRlciA+IDApIHsKICAgICAgZm9yIChjaGFubmVsID0gMDsgY2hhbm5lbCA8IG91dHB1dF9jaGFubmVsczsgY2hhbm5lbCsrKSB7CiAgICAgICAgZGF0YV92aWV3LnNldEludDgob2Zmc2V0KyssIG1pbl92YWx1ZVtjaGFubmVsXSk7CiAgICAgICAgZGF0YV92aWV3LnNldEludDgob2Zmc2V0KyssIG1heF92YWx1ZVtjaGFubmVsXSk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gYnVmZmVyOwogIH0KCiAgb25tZXNzYWdlID0gZnVuY3Rpb24gb25tZXNzYWdlKGV2dCkgewogICAgdmFyIGJ1ZmZlciA9IGdlbmVyYXRlV2F2ZWZvcm1EYXRhKGV2dC5kYXRhKTsgLy8gVHJhbnNmZXIgYnVmZmVyIHRvIHRoZSBjYWxsaW5nIHRocmVhZAoKICAgIHRoaXMucG9zdE1lc3NhZ2UoYnVmZmVyLCBbYnVmZmVyXSk7CiAgICB0aGlzLmNsb3NlKCk7CiAgfTsKCn0pKCk7Cgo=",u=null,c=!1,function(t){return d=d||g(l,u,c),new Worker(d,t)});function f(t){if(function(t){return t&&"object"===h(t)&&"sample_rate"in t&&"samples_per_pixel"in t&&"bits"in t&&"length"in t&&"data"in t}(t)&&(t=function(t){var e=t.data,s=t.channels||1,i=8===t.bits?1:2,n=2*t.length*s;if(e.length!==n)throw new Error("WaveformData.create(): Length mismatch in JSON waveform data");var a=24+e.length*i,r=new ArrayBuffer(a),o=new DataView(r);o.setInt32(0,2,!0),o.setUint32(4,8===t.bits,!0),o.setInt32(8,t.sample_rate,!0),o.setInt32(12,t.samples_per_pixel,!0),o.setInt32(16,t.length,!0),o.setInt32(20,s,!0);var h,g=24;if(8===t.bits)for(h=0;h<e.length;h++)o.setInt8(g++,e[h],!0);else for(h=0;h<e.length;h++)o.setInt16(g,e[h],!0),g+=2;return r}(t)),!function(t){var e=t&&"object"===h(t)&&"byteLength"in t;if(e){var s=new DataView(t).getInt32(0,!0);if(1!==s&&2!==s)throw new TypeError("WaveformData.create(): This waveform data version not supported")}return e}(t))throw new TypeError("WaveformData.create(): Unknown data format");this._data=new DataView(t),this._offset=2===this._version()?24:20,this._channels=[];for(var e=0;e<this.channels;e++)this._channels[e]=new n(this,e)}var I=512,b=1,p=!1,v=!1;function A(t,e,s){var i=function(t){for(var e=[],s=0;s<t.numberOfChannels;++s)e.push(t.getChannelData(s).buffer);return e}(t);if(e.disable_worker){var n=o({scale:e.scale,amplitude_scale:e.amplitude_scale,split_channels:e.split_channels,length:t.length,sample_rate:t.sampleRate,channels:i});s(null,new f(n),t)}else{var a=new m;a.onmessage=function(e){s(null,new f(e.data),t)},a.postMessage({scale:e.scale,amplitude_scale:e.amplitude_scale,split_channels:e.split_channels,length:t.length,sample_rate:t.sampleRate,channels:i},i)}}f.create=function(t){return new f(t)},f.createFromAudio=function(t,e){var s=function(t){return{scale:t.scale||I,amplitude_scale:t.amplitude_scale||b,split_channels:t.split_channels||p,disable_worker:t.disable_worker||v}}(t);if(t.audio_context&&t.array_buffer)return function(t,e,s,i){t.decodeAudioData(e,(function(t){A(t,s,i)}),(function(t){t||(t=new DOMException("EncodingError")),i(t)}))}(t.audio_context,t.array_buffer,s,e);if(t.audio_buffer)return A(t.audio_buffer,s,e);throw new TypeError("WaveformData.createFromAudio(): Pass either an AudioContext and ArrayBuffer, or an AudioBuffer object")},f.prototype={resample:function(t){if(t.scale="number"==typeof t.scale?t.scale:null,t.width="number"==typeof t.width?t.width:null,null!=t.width&&t.width<=0)throw new RangeError("WaveformData.resample(): width should be a positive integer value");if(null!=t.scale&&t.scale<=0)throw new RangeError("WaveformData.resample(): scale should be a positive integer value");if(!t.scale&&!t.width)throw new Error("WaveformData.resample(): Missing scale or width option");var e=t.scale||Math.floor(this.duration*this.sample_rate/t.width),s=this.scale,i=this.length,n=i*this.scale,a=Math.ceil(n/e),r=8===this.bits?1:2,o=24+2*a*this.channels*r,h=new ArrayBuffer(o),g=new DataView(h);g.setInt32(0,2,!0),g.setUint32(4,8===this.bits,!0),g.setInt32(8,this.sample_rate,!0),g.setInt32(12,e,!0),g.setInt32(16,a,!0),g.setInt32(20,this.channels,!0);var l,u=new f(h),c=0,d=0,m=this.channels,I=new Array(m),b=new Array(m);for(l=0;l<m;++l)i>0?(I[l]=this.channel(l).min_sample(c),b[l]=this.channel(l).max_sample(c)):(I[l]=0,b[l]=0);var p,v,A,C,w=8===this.bits?-128:-32768,y=8===this.bits?127:32767;if(e<s)throw new Error("WaveformData.resample(): Zoom level "+e+" too low, minimum: "+s);function W(t){return Math.floor(t*e)}for(;c<i;){for(;Math.floor(W(d)/s)===c;){if(d>0)for(l=0;l<m;++l)u.channel(l).set_min_sample(d-1,I[l]),u.channel(l).set_max_sample(d-1,b[l]);if(C=c,(p=W(++d))!==W(d-1))for(l=0;l<m;++l)I[l]=y,b[l]=w}for(p=W(d),(v=Math.floor(p/s))>i&&(v=i);c<v;){for(l=0;l<m;++l)(A=this.channel(l).min_sample(c))<I[l]&&(I[l]=A),(A=this.channel(l).max_sample(c))>b[l]&&(b[l]=A);c++}}if(c!==C)for(l=0;l<m;++l)u.channel(l).set_min_sample(d-1,I[l]),u.channel(l).set_max_sample(d-1,b[l]);return u},concat:function(){var t=this,e=Array.prototype.slice.call(arguments);e.forEach((function(e){if(t.channels!==e.channels||t.sample_rate!==e.sample_rate||t.bits!==e.bits||t.scale!==e.scale)throw new Error("WaveformData.concat(): Waveforms are incompatible")}));var s=this._concatBuffers.apply(this,e);return f.create(s)},_concatBuffers:function(){var t,e,s=Array.prototype.slice.call(arguments),i=this._offset,n=i,a=0,r=[this].concat(s).map((function(t){return t._data.buffer}));for(t=0;t<r.length;t++){e=r[t];var o=new DataView(e).getInt32(16,!0);n+=e.byteLength-i,a+=o}var h=new ArrayBuffer(n),g=new DataView(r[0]),l=new DataView(h);for(t=0;t<i;t++)l.setUint8(t,g.getUint8(t));l.setInt32(16,a,!0);var u=0,c=new Uint8Array(h,i);for(t=0;t<r.length;t++)e=r[t],c.set(new Uint8Array(e,i),u),u+=e.byteLength-i;return h},_offsetValues:function(t,e,s){var i=[],n=this.channels;s+=t*n*2;for(var a=0;a<e;a++)i.push(this._at(a*n*2+s));return i},_version:function(){return this._data.getInt32(0,!0)},get length(){return this._data.getUint32(16,!0)},get bits(){return Boolean(this._data.getUint32(4,!0))?8:16},get duration(){return this.length*this.scale/this.sample_rate},get pixels_per_second(){return this.sample_rate/this.scale},get seconds_per_pixel(){return this.scale/this.sample_rate},get channels(){return 2===this._version()?this._data.getInt32(20,!0):1},channel:function(t){if(t>=0&&t<this._channels.length)return this._channels[t];throw new RangeError("Invalid channel: "+t)},get sample_rate(){return this._data.getInt32(8,!0)},get scale(){return this._data.getInt32(12,!0)},_at:function(t){return 8===this.bits?this._data.getInt8(this._offset+t):this._data.getInt16(this._offset+2*t,!0)},_set_at:function(t,e){return 8===this.bits?this._data.setInt8(this._offset+t,e):this._data.setInt16(this._offset+2*t,e,!0)},at_time:function(t){return Math.floor(t*this.sample_rate/this.scale)},time:function(t){return t*this.scale/this.sample_rate},toJSON:function(){for(var t={version:2,channels:this.channels,sample_rate:this.sample_rate,samples_per_pixel:this.scale,bits:this.bits,length:this.length,data:[]},e=0;e<this.length;e++)for(var s=0;s<this.channels;s++)t.data.push(this.channel(s).min_sample(e)),t.data.push(this.channel(s).max_sample(e));return t},toArrayBuffer:function(){return this._data.buffer}};const C={};function w(t){return(e?s(e):s)(((e,s,n)=>({sources:[],sequence:[],...t,duration:0,currentTime:0,hoverTime:0,quality:1,bufferedSlices:[],waveforms:[],dimensions:{pageX:0,pageY:0,height:0,width:0,dpi:0},isLoading:!0,pointer:{isDown:!1},mouse:{isHover:!1,isActive:!1},setDimensions(t,s=0){e({dimensions:{width:t.width,height:t.height,pageY:t.y,pageX:t.x,dpi:s}})},setHover(t){e((e=>{const s=Math.abs(t)/e.dimensions.width;return{hoverTime:e.duration*s}}))},async fetchWaveform(t){if(t)return fetch(t).then((t=>t.arrayBuffer())).then((t=>async function(t){return f.create(t)}(t))).then((s=>(e((e=>({sources:(e.sources||[]).map((e=>e.waveform===t?{...e,duration:s.duration,data:s}:e))}))),s)))},resize:async function(t){const i=s(),n=[];let a=!1,r=0;const o=i.sequence&&0!==i.sequence.length?i.sequence:(i.sources||[]).map(((t,e)=>({startTime:t.segment?t.segment.start:0,endTime:t.segment?t.segment.end:i.duration,id:t.id,source:t.id+e,waveform:null}))),h=[];for(let e of o){const t=(i.sources||[]).filter((t=>{if(t.id===e.id){if(t.segment){const s=t.segment;return e.endTime>s.start&&e.startTime<s.end}return!0}return!1}));if(t.length>1){const s=e;for(let e=0;e<t.length;e++){const i=t[e],n=i.segment?Math.max(s.startTime,i.segment.start):s.startTime,a=i.segment?Math.min(s.endTime,i.segment.end):s.endTime;h.push({...s,source:s.id+"__"+n+"__"+a,startTime:n,endTime:a})}}else h.push(e)}let g=h.length;for(let s=0;s<h.length;s++){let o=h[s];if(t())return;e({loadingProgress:s/g});const u=(i.sources||[]).find((t=>!(t.id!==o.id)&&(!t.segment||o.startTime>=t.segment.start&&o.endTime<=t.segment.end))),c=u.segment?o.startTime-u.segment.start:o.startTime,d=u.segment?o.endTime-u.segment.start:o.endTime;if(!(d-c<=0)){if(u&&u.data&&i.dimensions.width){let t=i.quality;const e=(d||u.data.duration)-(c||0),s=e/i.duration,h=i.dimensions.width*s,g=Math.min(1,e/u.data.duration),m=r/i.duration*i.dimensions.width;let f=t*h*(1/g);const I=Math.floor(u.data.duration*u.data.sample_rate/f);I<u.data.scale&&(t*=I/u.data.scale,f=t*h*(1/g),console.warn("Selected quality too high, or segment too small",{quality:t,newWidth:f}));try{const e=u.data.resample({width:f});await new Promise((t=>setTimeout(t,0))),a=!0,n.push({...o,waveform:{data:e,atWidth:h,startPixel:m,quality:t,segment:u.segment}})}catch(l){console.error(l)}}else n.push(o);r+=d-c}}a&&e({sequence:n,loadingProgress:0})},async setAttributes(t,n,a){const r=[],o={isLoading:!0},h=[];if(void 0!==t.duration){const e=parseFloat(t.duration);Number.isNaN(e)||(o.duration=e)}if(void 0!==t["current-time"]&&(o.currentTime=Number(t["current-time"])),void 0!==t.srcset){const e=function(t){const e=[];if(-1===t.indexOf("#")&&-1!==t.indexOf(",")){const s=i(t,",");for(const t of s){const[s,n=s]=i(t," ");n&&s&&e.push({id:n,waveform:s,data:null})}}else{const s=i(t,"|");for(const t of s){const[s,n]=i(t," "),a={id:n,waveform:s,data:null};if(n&&-1!==n.indexOf("#t=")){const[t,e]=i(n,"#t="),[s,r]=i(e,","),o=parseFloat(s),h=parseFloat(r);Number.isNaN(o)||Number.isNaN(h)||(a.segment={start:o,end:h,id:n},a.id=t,a.duration=h-o)}n&&s&&e.push(a)}}return e}(t.srcset);for(const t of e)C[t.id]=C[t.id]?C[t.id]:[],C[t.id].push((()=>this.fetchWaveform(t.waveform)));o.sources=e}else if(void 0!==t.src){const[s,n=s]=i(t.src," ");s&&(o.sources=[{id:n,waveform:s,data:null,duration:-1}],r.push(this.fetchWaveform(s).then((t=>{e((e=>e.duration?{}:{duration:t.duration}))}))))}if(void 0!==t.quality){const e=parseFloat(t.quality);e&&!Number.isNaN(e)&&(o.quality=e)}if(void 0!==t.sequence){const e=[],s=i(t.sequence,"|");let n=0;for(const t of s){const[s,a]=i(t,"#t="),[o,g]=i(a,","),l=C[s];l&&!h.includes(s)&&(h.push(s),r.push(...l.map((t=>t()))),C[s]=null);const u=parseFloat(o),c=parseFloat(g);n+=c-u,e.push({startTime:u,endTime:c,id:s,source:t.replace(/[#,:.\n]/g,"__").trim(),waveform:null})}o.duration=n,o.sequence=e}if(e(o),(o.sources||o.sequence||o.quality)&&!n&&await s().resize(a),r.length){try{await Promise.all(r)}catch(g){console.error(g)}return e({isLoading:!1}),void(await s().resize(a))}e({isLoading:!1})}})));var e}function y(t,e,s=128){0===s&&(s=1);return e-(t+s/2)*e/s}function W(t,e){const s=document.createElementNS("http://www.w3.org/2000/svg",t);for(const i of Object.keys(e)){const t=e[i];s.setAttributeNS(null,i,t)}return s}class V extends HTMLElement{constructor(){super(),e(this,"store"),e(this,"hasInitialised",!1),e(this,"initialAttributes",{}),e(this,"unsubscribe"),e(this,"invalidation",{dimensions:!1,sequence:!1}),e(this,"svg"),e(this,"svgParts"),e(this,"buffered"),e(this,"waveformCache",{}),e(this,"lastBufferedStarts",[]),e(this,"lastWidth",-1),e(this,"lastHeight",-1),e(this,"resizeTimout",-1),e(this,"requeueResize",!1),e(this,"resize",(()=>{-1===this.resizeTimout&&(this.resizeTimout=setTimeout(this.forceResize,0))})),e(this,"isAlreadyResizing",!1),e(this,"forceResize",(()=>{this.resizeTimout=-1;const t=this.getBoundingClientRect(),e=window.devicePixelRatio||1;this.store.getState().setDimensions(t,e);const{width:s,height:i}=this.getBoundingClientRect();if(this.lastWidth=s,this.lastHeight=i,this.svg.setAttributeNS(null,"height",`${i}px`),this.svg.setAttributeNS(null,"width","100%"),this.svg.setAttributeNS(null,"preserveAspectRatio","none"),this.svg.setAttributeNS(null,"viewBox",`0 0 ${s} ${i}`),this.hasInitialised){if(this.isAlreadyResizing)return void(this.requeueResize=!0);this.isAlreadyResizing=!0,this.setIsLoading(!0),this.store.getState().resize((()=>this.requeueResize)).then((()=>{this.setIsLoading(!1),this.resizeTimout=-1,this.isAlreadyResizing=!1,this.requeueResize&&(this.resize(),this.requeueResize=!1)}))}})),e(this,"attributeQueue",{}),e(this,"attributeTimeout",-1),e(this,"isAlreadyUpdating",!1),e(this,"requeueUpdate",!1),e(this,"windowEvent",!1),this.attachShadow({mode:"open"});const t=document.createElement("style");t.innerHTML="\n        :host {\n            display: block;\n            --waveform-background: #000;\n            --waveform-base: #8a9aa1;\n            --waveform-hover: #14a4c3;\n            --waveform-buffered: #fff;\n            --waveform-progress: rgba(255, 255, 255, .4);\n        }\n\n        svg {\n            background: var(--waveform-background, #000);\n        }\n\n        svg .waveforms {\n            transition: opacity 140ms;\n        }\n\n        svg rect.hover {\n            fill: var(--waveform-hover, #14a4c3);\n        }\n\n        svg rect.base {\n            fill: var(--waveform-base, #8a9aa1);\n        }\n\n        svg rect.progress {\n            fill: var(--waveform-progress, #14a4c3);\n        }\n\n        svg .buffered rect {\n            fill: var(--waveform-buffered, #fff);\n        }\n\n        svg .loading {\n            translate: 0px -0.5px;\n        }\n    ",this.store=w({}),this.createEmptySVG(),this.shadowRoot.appendChild(this.svg),this.shadowRoot.appendChild(t);const s=this.render.bind(this);this.unsubscribe=this.store.subscribe(((t,e)=>{t.sequence!==e.sequence&&(this.invalidation.sequence=!0),t.isLoading!==e.isLoading&&this.setIsLoading(t.isLoading),t.loadingProgress!==e.loadingProgress&&this.svgParts.loading&&(this.svgParts.loading.style.width=100*t.loadingProgress+"%"),t.dimensions!==e.dimensions&&(this.invalidation.dimensions=!0),requestAnimationFrame(s)}))}set currentTime(t){this.store.setState({currentTime:t})}get currentTime(){return this.store.getState().currentTime}get duration(){return this.store.getState().duration}get quality(){return this.store.getState().quality}reseek(t){t&&(this.buffered=t),this.buffered}createEmptySVG(){this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.setAttribute("xmlns","http://www.w3.org/2000/svg"),this.svg.style.background="var(--waveform-background, #000)";const t=(Math.random()+1).toString(36).substring(2);this.svgParts={loading:W("rect",{x:"0",y:"50%",width:"",height:"1",fill:"#fff",class:"loading"}),mask:W("mask",{id:"waveform-"+t}),waveforms:W("g",{class:"waveforms"}),maskBg:W("rect",{x:"0",y:"0",width:`${this.store.getState().dimensions.width}px`,height:"100%",fill:"#000"}),base:W("rect",{class:"base",mask:"url(#waveform-"+t+")",x:"0px",y:"0px",width:"100%",height:"100%"}),progress:W("rect",{class:"progress",mask:"url(#waveform-"+t+")",x:"0px",y:"0px",width:"0px",height:"100%"}),hover:W("rect",{class:"hover",mask:"url(#waveform-"+t+")",x:"0px",y:"0px",height:"100%"}),buffered:W("g",{class:"buffered"}),line:W("line",{class:"waveform-line",x1:"0px",stroke:"#999"})},this.svgParts.mask.appendChild(this.svgParts.maskBg),this.svgParts.mask.appendChild(this.svgParts.waveforms),this.svgParts.waveforms.appendChild(this.svgParts.line);const e=W("defs",{});e.appendChild(this.svgParts.mask),this.svg.appendChild(e),this.svg.appendChild(this.svgParts.base),this.svg.appendChild(this.svgParts.buffered),this.svg.appendChild(this.svgParts.hover),this.svg.appendChild(this.svgParts.progress),this.svg.appendChild(this.svgParts.loading)}resizeSVG(){const t=this.store.getState().dimensions;this.svgParts.maskBg.setAttributeNS(null,"width",`${t.width}px`),this.svgParts.base.setAttributeNS(null,"height",`${t.height}px`),this.svgParts.progress.setAttributeNS(null,"height",`${t.height}px`),this.svgParts.hover.setAttributeNS(null,"height",`${t.height}px`),this.svgParts.line.setAttributeNS(null,"x2",`${t.width}px`),this.svgParts.line.setAttributeNS(null,"y1",t.height/2+"px"),this.svgParts.line.setAttributeNS(null,"y2",t.height/2+"px")}addSequenceToSVG(t){if(!t.waveform)return;const e=this.svgParts.waveforms.querySelector(`[data-sequence="${t.source}"]`),s=t.waveform.data,i=s.channel(0),n=t.waveform.segment?t.startTime-t.waveform.segment.start:t.startTime;let a=t.waveform.segment?t.endTime-t.waveform.segment.start:t.endTime;a>s.duration&&(console.warn("Data does not match waveform duration",{overflow:a-s.duration}),a=s.duration-.01);const r=~~(s.pixels_per_second*n),o=r+~~(s.pixels_per_second*(a-n)),h=this.store.getState().dimensions.height,g=[];let l,u=!1;const c=[],d=[];for(let p=r;p<o;p++)try{const t=i.max_sample(p);Number.isSafeInteger(t)&&(c[p]=t)}catch(b){l=b,u=!0}for(let p=o;p>=r;p--)try{const t=i.min_sample(p);Number.isSafeInteger(t)&&(d[p]=t)}catch(b){l=b,u=!0}if(0===c.length||0===d.length)return;const m=2.5*Math.max(0,...c.filter((t=>void 0!==t))),f=2.5*Math.abs(Math.min(...d.filter((t=>void 0!==t))));for(let p=r;p<o;p++){const e=c[p];if(void 0!==e){const s=(p-r)/(t.waveform.quality||1);g.push([t.waveform.startPixel+(0===s?-2:s+.5),y(e,h,m+1)+.5])}}for(let p=o;p>=r;p--){const e=d[p];if(void 0!==e){const s=(p-r)/(t.waveform.quality||1);g.push([t.waveform.startPixel+(0===s?-2:s+.5),y(e,h,f+1)+.5])}}u&&(l&&console.error(l),console.error("Error rendering waveform",i,t),console.log("Debug component",this.outerHTML));const I=g.map((t=>t.join(","))).join(" ");if(e)e.setAttributeNS(null,"points",I);else{const e=W("polygon",{points:I,fill:"#fff","data-sequence":t.source});this.svgParts.waveforms.appendChild(e)}}removeSequenceFromSVG(t){var e;const s=this.svgParts.waveforms.querySelector(`[data-sequence="${t}"]`);s&&(null==(e=s.parentNode)||e.removeChild(s))}render(){const{isLoading:t,sources:e,currentTime:s,sequence:i,dimensions:n,hoverTime:a,duration:r,mouse:o}=this.store.getState();if(this.invalidation.dimensions&&(this.resizeSVG(),this.reseek(),this.invalidation.dimensions=!1),this.invalidation.sequence){const t=i.map((t=>t.source));for(const e of[...this.svgParts.waveforms.children]){const s=e.getAttribute("data-sequence");t.includes(s)||this.removeSequenceFromSVG(s)}for(const e of i)this.addSequenceToSVG(e);this.invalidation.sequence=!1}if(t)return;const h=o.isHover?Math.abs(~~(n.width/r*a)):0,g=Math.abs(~~(n.width/r*s));this.svgParts.hover.setAttributeNS(null,"width",`${h}px`),this.svgParts.base.setAttributeNS(null,"x",`${h}px`),this.svgParts.progress.setAttributeNS(null,"width",`${g}px`)}static get observedAttributes(){return["src","srcset","duration","quality","sequence","current-time","resize"]}setIsLoading(t){this.svgParts.waveforms.style.opacity=""+(t?0:1)}connectedCallback(){if(this.isConnected){"true"===this.initialAttributes.resize&&(this.windowEvent=!0,window.addEventListener("resize",this.resize)),this.store.getState().setAttributes(this.initialAttributes,!0,(()=>!1)).then((()=>{})),this.initialAttributes={},this.resize(),this.hasInitialised=!0;const t={x:0,y:0,moved:!1};this.addEventListener("touchstart",(e=>{e.preventDefault();const{dimensions:s}=this.store.getState();this.store.setState({pointer:{isDown:!0}}),t.x=e.touches[0].pageX-s.pageX,t.y=e.touches[0].pageY-s.pageY,this.store.getState().setHover(t.x)})),this.addEventListener("touchmove",(e=>{if(this.store.getState().pointer.isDown&&e.touches.length){e.preventDefault();const{dimensions:s}=this.store.getState();t.x=e.touches[0].pageX-s.pageX,t.y=e.touches[0].pageY-s.pageY,t.moved=!0,this.store.getState().setHover(t.x)}})),this.addEventListener("touchend",(e=>{e.preventDefault(),this.store.getState().pointer.isDown&&(this.store.setState({pointer:{isDown:!1}}),this.moveToPoint(t,!0),t.moved=!1)})),this.addEventListener("click",(t=>{t.preventDefault();const{dimensions:e}=this.store.getState(),s={x:t.pageX-e.pageX,y:t.pageY-e.pageY};this.moveToPoint(s,!0)})),this.addEventListener("mousemove",(t=>{const{dimensions:e}=this.store.getState(),s={x:t.pageX-e.pageX,y:t.pageY-e.pageY};this.store.getState().setHover(s.x)})),this.addEventListener("pointerenter",(t=>{this.store.setState((t=>({mouse:{...t.mouse,isHover:!0}})))})),this.addEventListener("pointerleave",(t=>{this.store.setState((t=>({mouse:{...t.mouse,isHover:!1}})))})),this.addEventListener("pointerdown",(t=>{this.store.setState((t=>({mouse:{...t.mouse,isActive:!0}})))})),this.addEventListener("pointerup",(t=>{this.store.setState((t=>({mouse:{...t.mouse,isActive:!1}})))}))}}moveToPoint(t,e=!1){this.store.setState((s=>{const i=Math.abs(t.x)/s.dimensions.width,n=s.duration*i;let a,r=0;for(const t of s.sequence){if(a=t,n<r+t.endTime-t.startTime)break;r+=t.endTime-t.startTime}if(e){if(!this.dispatchEvent(new CustomEvent("click-waveform",{detail:{time:n,percent:i,target:t,currentSequence:a,sequenceTime:n-r},cancelable:!0,bubbles:!0})))return{}}return this.setAttribute("current-time",`${n}`),{currentTime:n}}))}attributeChangedCallback(t,e,s){this.hasInitialised?(this.attributeQueue[t]=s,this.queueUpdate()):this.initialAttributes[t]=s}queueUpdate(){-1===this.attributeTimeout&&(this.attributeTimeout=setTimeout(this.updateAttributes.bind(this),10)),this.requeueUpdate=!1}updateAttributes(){this.attributeTimeout=-1,this.isAlreadyUpdating?this.requeueUpdate=!0:this.hasInitialised&&(this.isAlreadyUpdating=!0,this.setIsLoading(!0),this.store.getState().setAttributes(this.attributeQueue,!1,(()=>this.requeueUpdate)).then((()=>{this.setIsLoading(!1),this.isAlreadyUpdating=!1,this.requeueUpdate&&this.queueUpdate()})),this.attributeQueue={})}disconnectedCallback(){this.unsubscribe(),this.windowEvent&&window.removeEventListener("resize",this.resize)}}customElements.define("waveform-panel",V),console.log("<waveform-panel /> version v1.2.0"),exports.WaveformPanel=V;
//# sourceMappingURL=index.js.map
