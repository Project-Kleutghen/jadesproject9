var __defProp=Object.defineProperty,__defNormalProp=(e,t,s)=>t in e?__defProp(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,__publicField=(e,t,s)=>(__defNormalProp(e,"symbol"!=typeof t?t+"":t,s),s);!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).WaveformPanel={})}(this,(function(e){"use strict";const t=e=>{let t;const s=new Set,i=(e,i)=>{const n="function"==typeof e?e(t):e;if(!Object.is(n,t)){const e=t;t=(null!=i?i:"object"!=typeof n)?n:Object.assign({},t,n),s.forEach((s=>s(t,e)))}},n=()=>t,a={setState:i,getState:n,subscribe:e=>(s.add(e),()=>s.delete(e)),destroy:()=>s.clear()};return t=e(i,n,a),a};function s(e,t){const s=(e||"").replace(/\n/,"").trim();return void 0!==t?s.split(t):s}function i(e,t){this._waveformData=e,this._channelIndex=t}i.prototype.min_sample=function(e){var t=2*(e*this._waveformData.channels+this._channelIndex);return this._waveformData._at(t)},i.prototype.max_sample=function(e){var t=2*(e*this._waveformData.channels+this._channelIndex)+1;return this._waveformData._at(t)},i.prototype.set_min_sample=function(e,t){var s=2*(e*this._waveformData.channels+this._channelIndex);return this._waveformData._set_at(s,t)},i.prototype.set_max_sample=function(e,t){var s=2*(e*this._waveformData.channels+this._channelIndex)+1;return this._waveformData._set_at(s,t)},i.prototype.min_array=function(){return this._waveformData._offsetValues(0,this._waveformData.length,2*this._channelIndex)},i.prototype.max_array=function(){return this._waveformData._offsetValues(0,this._waveformData.length,2*this._channelIndex+1)};var n=127,a=-128;function r(e){var t,s,i=e.scale,r=e.amplitude_scale,o=e.split_channels,l=e.length,h=e.sample_rate,g=e.channels.map((function(e){return new Float32Array(e)})),u=o?g.length:1,d=1===u?1:2,c=1===d?20:24,m=function(e,t){var s=Math.floor(e/t);return e-s*t>0&&s++,s}(l,i),f=new ArrayBuffer(c+2*m*u),I=new DataView(f),b=0,p=c,v=new Array(u),A=new Array(u);for(t=0;t<u;t++)v[t]=1/0,A[t]=-1/0;for(I.setInt32(0,d,!0),I.setUint32(4,1,!0),I.setInt32(8,h,!0),I.setInt32(12,i,!0),I.setInt32(16,m,!0),2===d&&I.setInt32(20,u,!0),s=0;s<l;s++){var C=0;if(1===u){for(t=0;t<g.length;++t)C+=g[t][s];(C=Math.floor(n*C*r/g.length))<v[0]&&(v[0]=C,v[0]<a&&(v[0]=a)),C>A[0]&&(A[0]=C,A[0]>n&&(A[0]=n))}else for(t=0;t<u;++t)(C=Math.floor(n*g[t][s]*r))<v[t]&&(v[t]=C,v[t]<a&&(v[t]=a)),C>A[t]&&(A[t]=C,A[t]>n&&(A[t]=n));if(++b===i){for(t=0;t<u;t++)I.setInt8(p++,v[t]),I.setInt8(p++,A[t]),v[t]=1/0,A[t]=-1/0;b=0}}if(b>0)for(t=0;t<u;t++)I.setInt8(p++,v[t]),I.setInt8(p++,A[t]);return f}function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function l(e,t,s){var i=void 0===t?null:t,n=function(e,t){var s=atob(e);if(t){for(var i=new Uint8Array(s.length),n=0,a=s.length;n<a;++n)i[n]=s.charCodeAt(n);return String.fromCharCode.apply(null,new Uint16Array(i.buffer))}return s}(e,void 0!==s&&s),a=n.indexOf("\n",10)+1,r=n.substring(a)+(i?"//# sourceMappingURL="+i:""),o=new Blob([r],{type:"application/javascript"});return URL.createObjectURL(o)}var h,g,u,d,c=(h="Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwooZnVuY3Rpb24gKCkgewogICd1c2Ugc3RyaWN0JzsKCiAgLyoqCiAgICogQXVkaW9CdWZmZXItYmFzZWQgV2F2ZWZvcm1EYXRhIGdlbmVyYXRvcgogICAqCiAgICogQWRhcHRlZCBmcm9tIEJsb2NrRmlsZTo6Q2FsY1N1bW1hcnkgaW4gQXVkYWNpdHksIHdpdGggcGVybWlzc2lvbi4KICAgKiBTZWUgaHR0cHM6Ly9jb2RlLmdvb2dsZS5jb20vcC9hdWRhY2l0eS9zb3VyY2UvYnJvd3NlL2F1ZGFjaXR5LXNyYy90cnVuay9zcmMvQmxvY2tGaWxlLmNwcAogICAqLwogIHZhciBJTlQ4X01BWCA9IDEyNzsKICB2YXIgSU5UOF9NSU4gPSAtMTI4OwoKICBmdW5jdGlvbiBjYWxjdWxhdGVXYXZlZm9ybURhdGFMZW5ndGgoYXVkaW9fc2FtcGxlX2NvdW50LCBzY2FsZSkgewogICAgdmFyIGRhdGFfbGVuZ3RoID0gTWF0aC5mbG9vcihhdWRpb19zYW1wbGVfY291bnQgLyBzY2FsZSk7CiAgICB2YXIgc2FtcGxlc19yZW1haW5pbmcgPSBhdWRpb19zYW1wbGVfY291bnQgLSBkYXRhX2xlbmd0aCAqIHNjYWxlOwoKICAgIGlmIChzYW1wbGVzX3JlbWFpbmluZyA+IDApIHsKICAgICAgZGF0YV9sZW5ndGgrKzsKICAgIH0KCiAgICByZXR1cm4gZGF0YV9sZW5ndGg7CiAgfQoKICBmdW5jdGlvbiBnZW5lcmF0ZVdhdmVmb3JtRGF0YShvcHRpb25zKSB7CiAgICB2YXIgc2NhbGUgPSBvcHRpb25zLnNjYWxlOwogICAgdmFyIGFtcGxpdHVkZV9zY2FsZSA9IG9wdGlvbnMuYW1wbGl0dWRlX3NjYWxlOwogICAgdmFyIHNwbGl0X2NoYW5uZWxzID0gb3B0aW9ucy5zcGxpdF9jaGFubmVsczsKICAgIHZhciBsZW5ndGggPSBvcHRpb25zLmxlbmd0aDsKICAgIHZhciBzYW1wbGVfcmF0ZSA9IG9wdGlvbnMuc2FtcGxlX3JhdGU7CiAgICB2YXIgY2hhbm5lbHMgPSBvcHRpb25zLmNoYW5uZWxzLm1hcChmdW5jdGlvbiAoY2hhbm5lbCkgewogICAgICByZXR1cm4gbmV3IEZsb2F0MzJBcnJheShjaGFubmVsKTsKICAgIH0pOwogICAgdmFyIG91dHB1dF9jaGFubmVscyA9IHNwbGl0X2NoYW5uZWxzID8gY2hhbm5lbHMubGVuZ3RoIDogMTsKICAgIHZhciB2ZXJzaW9uID0gb3V0cHV0X2NoYW5uZWxzID09PSAxID8gMSA6IDI7CiAgICB2YXIgaGVhZGVyX3NpemUgPSB2ZXJzaW9uID09PSAxID8gMjAgOiAyNDsKICAgIHZhciBkYXRhX2xlbmd0aCA9IGNhbGN1bGF0ZVdhdmVmb3JtRGF0YUxlbmd0aChsZW5ndGgsIHNjYWxlKTsKICAgIHZhciB0b3RhbF9zaXplID0gaGVhZGVyX3NpemUgKyBkYXRhX2xlbmd0aCAqIDIgKiBvdXRwdXRfY2hhbm5lbHM7CiAgICB2YXIgYnVmZmVyID0gbmV3IEFycmF5QnVmZmVyKHRvdGFsX3NpemUpOwogICAgdmFyIGRhdGFfdmlldyA9IG5ldyBEYXRhVmlldyhidWZmZXIpOwogICAgdmFyIHNjYWxlX2NvdW50ZXIgPSAwOwogICAgdmFyIG9mZnNldCA9IGhlYWRlcl9zaXplOwogICAgdmFyIGNoYW5uZWwsIGk7CiAgICB2YXIgbWluX3ZhbHVlID0gbmV3IEFycmF5KG91dHB1dF9jaGFubmVscyk7CiAgICB2YXIgbWF4X3ZhbHVlID0gbmV3IEFycmF5KG91dHB1dF9jaGFubmVscyk7CgogICAgZm9yIChjaGFubmVsID0gMDsgY2hhbm5lbCA8IG91dHB1dF9jaGFubmVsczsgY2hhbm5lbCsrKSB7CiAgICAgIG1pbl92YWx1ZVtjaGFubmVsXSA9IEluZmluaXR5OwogICAgICBtYXhfdmFsdWVbY2hhbm5lbF0gPSAtSW5maW5pdHk7CiAgICB9CgogICAgZGF0YV92aWV3LnNldEludDMyKDAsIHZlcnNpb24sIHRydWUpOyAvLyBWZXJzaW9uCgogICAgZGF0YV92aWV3LnNldFVpbnQzMig0LCAxLCB0cnVlKTsgLy8gSXMgOCBiaXQ/CgogICAgZGF0YV92aWV3LnNldEludDMyKDgsIHNhbXBsZV9yYXRlLCB0cnVlKTsgLy8gU2FtcGxlIHJhdGUKCiAgICBkYXRhX3ZpZXcuc2V0SW50MzIoMTIsIHNjYWxlLCB0cnVlKTsgLy8gU2NhbGUKCiAgICBkYXRhX3ZpZXcuc2V0SW50MzIoMTYsIGRhdGFfbGVuZ3RoLCB0cnVlKTsgLy8gTGVuZ3RoCgogICAgaWYgKHZlcnNpb24gPT09IDIpIHsKICAgICAgZGF0YV92aWV3LnNldEludDMyKDIwLCBvdXRwdXRfY2hhbm5lbHMsIHRydWUpOwogICAgfQoKICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICB2YXIgc2FtcGxlID0gMDsKCiAgICAgIGlmIChvdXRwdXRfY2hhbm5lbHMgPT09IDEpIHsKICAgICAgICBmb3IgKGNoYW5uZWwgPSAwOyBjaGFubmVsIDwgY2hhbm5lbHMubGVuZ3RoOyArK2NoYW5uZWwpIHsKICAgICAgICAgIHNhbXBsZSArPSBjaGFubmVsc1tjaGFubmVsXVtpXTsKICAgICAgICB9CgogICAgICAgIHNhbXBsZSA9IE1hdGguZmxvb3IoSU5UOF9NQVggKiBzYW1wbGUgKiBhbXBsaXR1ZGVfc2NhbGUgLyBjaGFubmVscy5sZW5ndGgpOwoKICAgICAgICBpZiAoc2FtcGxlIDwgbWluX3ZhbHVlWzBdKSB7CiAgICAgICAgICBtaW5fdmFsdWVbMF0gPSBzYW1wbGU7CgogICAgICAgICAgaWYgKG1pbl92YWx1ZVswXSA8IElOVDhfTUlOKSB7CiAgICAgICAgICAgIG1pbl92YWx1ZVswXSA9IElOVDhfTUlOOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHNhbXBsZSA+IG1heF92YWx1ZVswXSkgewogICAgICAgICAgbWF4X3ZhbHVlWzBdID0gc2FtcGxlOwoKICAgICAgICAgIGlmIChtYXhfdmFsdWVbMF0gPiBJTlQ4X01BWCkgewogICAgICAgICAgICBtYXhfdmFsdWVbMF0gPSBJTlQ4X01BWDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yIChjaGFubmVsID0gMDsgY2hhbm5lbCA8IG91dHB1dF9jaGFubmVsczsgKytjaGFubmVsKSB7CiAgICAgICAgICBzYW1wbGUgPSBNYXRoLmZsb29yKElOVDhfTUFYICogY2hhbm5lbHNbY2hhbm5lbF1baV0gKiBhbXBsaXR1ZGVfc2NhbGUpOwoKICAgICAgICAgIGlmIChzYW1wbGUgPCBtaW5fdmFsdWVbY2hhbm5lbF0pIHsKICAgICAgICAgICAgbWluX3ZhbHVlW2NoYW5uZWxdID0gc2FtcGxlOwoKICAgICAgICAgICAgaWYgKG1pbl92YWx1ZVtjaGFubmVsXSA8IElOVDhfTUlOKSB7CiAgICAgICAgICAgICAgbWluX3ZhbHVlW2NoYW5uZWxdID0gSU5UOF9NSU47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoc2FtcGxlID4gbWF4X3ZhbHVlW2NoYW5uZWxdKSB7CiAgICAgICAgICAgIG1heF92YWx1ZVtjaGFubmVsXSA9IHNhbXBsZTsKCiAgICAgICAgICAgIGlmIChtYXhfdmFsdWVbY2hhbm5lbF0gPiBJTlQ4X01BWCkgewogICAgICAgICAgICAgIG1heF92YWx1ZVtjaGFubmVsXSA9IElOVDhfTUFYOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoKytzY2FsZV9jb3VudGVyID09PSBzY2FsZSkgewogICAgICAgIGZvciAoY2hhbm5lbCA9IDA7IGNoYW5uZWwgPCBvdXRwdXRfY2hhbm5lbHM7IGNoYW5uZWwrKykgewogICAgICAgICAgZGF0YV92aWV3LnNldEludDgob2Zmc2V0KyssIG1pbl92YWx1ZVtjaGFubmVsXSk7CiAgICAgICAgICBkYXRhX3ZpZXcuc2V0SW50OChvZmZzZXQrKywgbWF4X3ZhbHVlW2NoYW5uZWxdKTsKICAgICAgICAgIG1pbl92YWx1ZVtjaGFubmVsXSA9IEluZmluaXR5OwogICAgICAgICAgbWF4X3ZhbHVlW2NoYW5uZWxdID0gLUluZmluaXR5OwogICAgICAgIH0KCiAgICAgICAgc2NhbGVfY291bnRlciA9IDA7CiAgICAgIH0KICAgIH0KCiAgICBpZiAoc2NhbGVfY291bnRlciA+IDApIHsKICAgICAgZm9yIChjaGFubmVsID0gMDsgY2hhbm5lbCA8IG91dHB1dF9jaGFubmVsczsgY2hhbm5lbCsrKSB7CiAgICAgICAgZGF0YV92aWV3LnNldEludDgob2Zmc2V0KyssIG1pbl92YWx1ZVtjaGFubmVsXSk7CiAgICAgICAgZGF0YV92aWV3LnNldEludDgob2Zmc2V0KyssIG1heF92YWx1ZVtjaGFubmVsXSk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gYnVmZmVyOwogIH0KCiAgb25tZXNzYWdlID0gZnVuY3Rpb24gb25tZXNzYWdlKGV2dCkgewogICAgdmFyIGJ1ZmZlciA9IGdlbmVyYXRlV2F2ZWZvcm1EYXRhKGV2dC5kYXRhKTsgLy8gVHJhbnNmZXIgYnVmZmVyIHRvIHRoZSBjYWxsaW5nIHRocmVhZAoKICAgIHRoaXMucG9zdE1lc3NhZ2UoYnVmZmVyLCBbYnVmZmVyXSk7CiAgICB0aGlzLmNsb3NlKCk7CiAgfTsKCn0pKCk7Cgo=",g=null,u=!1,function(e){return d=d||l(h,g,u),new Worker(d,e)});function m(e){if(function(e){return e&&"object"===o(e)&&"sample_rate"in e&&"samples_per_pixel"in e&&"bits"in e&&"length"in e&&"data"in e}(e)&&(e=function(e){var t=e.data,s=e.channels||1,i=8===e.bits?1:2,n=2*e.length*s;if(t.length!==n)throw new Error("WaveformData.create(): Length mismatch in JSON waveform data");var a=24+t.length*i,r=new ArrayBuffer(a),o=new DataView(r);o.setInt32(0,2,!0),o.setUint32(4,8===e.bits,!0),o.setInt32(8,e.sample_rate,!0),o.setInt32(12,e.samples_per_pixel,!0),o.setInt32(16,e.length,!0),o.setInt32(20,s,!0);var l,h=24;if(8===e.bits)for(l=0;l<t.length;l++)o.setInt8(h++,t[l],!0);else for(l=0;l<t.length;l++)o.setInt16(h,t[l],!0),h+=2;return r}(e)),!function(e){var t=e&&"object"===o(e)&&"byteLength"in e;if(t){var s=new DataView(e).getInt32(0,!0);if(1!==s&&2!==s)throw new TypeError("WaveformData.create(): This waveform data version not supported")}return t}(e))throw new TypeError("WaveformData.create(): Unknown data format");this._data=new DataView(e),this._offset=2===this._version()?24:20,this._channels=[];for(var t=0;t<this.channels;t++)this._channels[t]=new i(this,t)}var f=512,I=1,b=!1,p=!1;function v(e,t,s){var i=function(e){for(var t=[],s=0;s<e.numberOfChannels;++s)t.push(e.getChannelData(s).buffer);return t}(e);if(t.disable_worker){var n=r({scale:t.scale,amplitude_scale:t.amplitude_scale,split_channels:t.split_channels,length:e.length,sample_rate:e.sampleRate,channels:i});s(null,new m(n),e)}else{var a=new c;a.onmessage=function(t){s(null,new m(t.data),e)},a.postMessage({scale:t.scale,amplitude_scale:t.amplitude_scale,split_channels:t.split_channels,length:e.length,sample_rate:e.sampleRate,channels:i},i)}}m.create=function(e){return new m(e)},m.createFromAudio=function(e,t){var s=function(e){return{scale:e.scale||f,amplitude_scale:e.amplitude_scale||I,split_channels:e.split_channels||b,disable_worker:e.disable_worker||p}}(e);if(e.audio_context&&e.array_buffer)return function(e,t,s,i){e.decodeAudioData(t,(function(e){v(e,s,i)}),(function(e){e||(e=new DOMException("EncodingError")),i(e)}))}(e.audio_context,e.array_buffer,s,t);if(e.audio_buffer)return v(e.audio_buffer,s,t);throw new TypeError("WaveformData.createFromAudio(): Pass either an AudioContext and ArrayBuffer, or an AudioBuffer object")},m.prototype={resample:function(e){if(e.scale="number"==typeof e.scale?e.scale:null,e.width="number"==typeof e.width?e.width:null,null!=e.width&&e.width<=0)throw new RangeError("WaveformData.resample(): width should be a positive integer value");if(null!=e.scale&&e.scale<=0)throw new RangeError("WaveformData.resample(): scale should be a positive integer value");if(!e.scale&&!e.width)throw new Error("WaveformData.resample(): Missing scale or width option");var t=e.scale||Math.floor(this.duration*this.sample_rate/e.width),s=this.scale,i=this.length,n=i*this.scale,a=Math.ceil(n/t),r=8===this.bits?1:2,o=24+2*a*this.channels*r,l=new ArrayBuffer(o),h=new DataView(l);h.setInt32(0,2,!0),h.setUint32(4,8===this.bits,!0),h.setInt32(8,this.sample_rate,!0),h.setInt32(12,t,!0),h.setInt32(16,a,!0),h.setInt32(20,this.channels,!0);var g,u=new m(l),d=0,c=0,f=this.channels,I=new Array(f),b=new Array(f);for(g=0;g<f;++g)i>0?(I[g]=this.channel(g).min_sample(d),b[g]=this.channel(g).max_sample(d)):(I[g]=0,b[g]=0);var p,v,A,C,w=8===this.bits?-128:-32768,_=8===this.bits?127:32767;if(t<s)throw new Error("WaveformData.resample(): Zoom level "+t+" too low, minimum: "+s);function y(e){return Math.floor(e*t)}for(;d<i;){for(;Math.floor(y(c)/s)===d;){if(c>0)for(g=0;g<f;++g)u.channel(g).set_min_sample(c-1,I[g]),u.channel(g).set_max_sample(c-1,b[g]);if(C=d,(p=y(++c))!==y(c-1))for(g=0;g<f;++g)I[g]=_,b[g]=w}for(p=y(c),(v=Math.floor(p/s))>i&&(v=i);d<v;){for(g=0;g<f;++g)(A=this.channel(g).min_sample(d))<I[g]&&(I[g]=A),(A=this.channel(g).max_sample(d))>b[g]&&(b[g]=A);d++}}if(d!==C)for(g=0;g<f;++g)u.channel(g).set_min_sample(c-1,I[g]),u.channel(g).set_max_sample(c-1,b[g]);return u},concat:function(){var e=this,t=Array.prototype.slice.call(arguments);t.forEach((function(t){if(e.channels!==t.channels||e.sample_rate!==t.sample_rate||e.bits!==t.bits||e.scale!==t.scale)throw new Error("WaveformData.concat(): Waveforms are incompatible")}));var s=this._concatBuffers.apply(this,t);return m.create(s)},_concatBuffers:function(){var e,t,s=Array.prototype.slice.call(arguments),i=this._offset,n=i,a=0,r=[this].concat(s).map((function(e){return e._data.buffer}));for(e=0;e<r.length;e++){t=r[e];var o=new DataView(t).getInt32(16,!0);n+=t.byteLength-i,a+=o}var l=new ArrayBuffer(n),h=new DataView(r[0]),g=new DataView(l);for(e=0;e<i;e++)g.setUint8(e,h.getUint8(e));g.setInt32(16,a,!0);var u=0,d=new Uint8Array(l,i);for(e=0;e<r.length;e++)t=r[e],d.set(new Uint8Array(t,i),u),u+=t.byteLength-i;return l},_offsetValues:function(e,t,s){var i=[],n=this.channels;s+=e*n*2;for(var a=0;a<t;a++)i.push(this._at(a*n*2+s));return i},_version:function(){return this._data.getInt32(0,!0)},get length(){return this._data.getUint32(16,!0)},get bits(){return Boolean(this._data.getUint32(4,!0))?8:16},get duration(){return this.length*this.scale/this.sample_rate},get pixels_per_second(){return this.sample_rate/this.scale},get seconds_per_pixel(){return this.scale/this.sample_rate},get channels(){return 2===this._version()?this._data.getInt32(20,!0):1},channel:function(e){if(e>=0&&e<this._channels.length)return this._channels[e];throw new RangeError("Invalid channel: "+e)},get sample_rate(){return this._data.getInt32(8,!0)},get scale(){return this._data.getInt32(12,!0)},_at:function(e){return 8===this.bits?this._data.getInt8(this._offset+e):this._data.getInt16(this._offset+2*e,!0)},_set_at:function(e,t){return 8===this.bits?this._data.setInt8(this._offset+e,t):this._data.setInt16(this._offset+2*e,t,!0)},at_time:function(e){return Math.floor(e*this.sample_rate/this.scale)},time:function(e){return e*this.scale/this.sample_rate},toJSON:function(){for(var e={version:2,channels:this.channels,sample_rate:this.sample_rate,samples_per_pixel:this.scale,bits:this.bits,length:this.length,data:[]},t=0;t<this.length;t++)for(var s=0;s<this.channels;s++)e.data.push(this.channel(s).min_sample(t)),e.data.push(this.channel(s).max_sample(t));return e},toArrayBuffer:function(){return this._data.buffer}};const A={};function C(e){return(i?t(i):t)(((t,i,n)=>({sources:[],sequence:[],...e,duration:0,currentTime:0,hoverTime:0,quality:1,bufferedSlices:[],waveforms:[],dimensions:{pageX:0,pageY:0,height:0,width:0,dpi:0},isLoading:!0,pointer:{isDown:!1},mouse:{isHover:!1,isActive:!1},setDimensions(e,s=0){t({dimensions:{width:e.width,height:e.height,pageY:e.y,pageX:e.x,dpi:s}})},setHover(e){t((t=>{const s=Math.abs(e)/t.dimensions.width;return{hoverTime:t.duration*s}}))},async fetchWaveform(e){if(e)return fetch(e).then((e=>e.arrayBuffer())).then((e=>async function(e){return m.create(e)}(e))).then((s=>(t((t=>({sources:(t.sources||[]).map((t=>t.waveform===e?{...t,duration:s.duration,data:s}:t))}))),s)))},resize:async function(e){const s=i(),n=[];let a=!1,r=0;const o=s.sequence&&0!==s.sequence.length?s.sequence:(s.sources||[]).map(((e,t)=>({startTime:e.segment?e.segment.start:0,endTime:e.segment?e.segment.end:s.duration,id:e.id,source:e.id+t,waveform:null}))),l=[];for(let t of o){const e=(s.sources||[]).filter((e=>{if(e.id===t.id){if(e.segment){const s=e.segment;return t.endTime>s.start&&t.startTime<s.end}return!0}return!1}));if(e.length>1){const s=t;for(let t=0;t<e.length;t++){const i=e[t],n=i.segment?Math.max(s.startTime,i.segment.start):s.startTime,a=i.segment?Math.min(s.endTime,i.segment.end):s.endTime;l.push({...s,source:s.id+"__"+n+"__"+a,startTime:n,endTime:a})}}else l.push(t)}let h=l.length;for(let i=0;i<l.length;i++){let o=l[i];if(e())return;t({loadingProgress:i/h});const u=(s.sources||[]).find((e=>!(e.id!==o.id)&&(!e.segment||o.startTime>=e.segment.start&&o.endTime<=e.segment.end))),d=u.segment?o.startTime-u.segment.start:o.startTime,c=u.segment?o.endTime-u.segment.start:o.endTime;if(!(c-d<=0)){if(u&&u.data&&s.dimensions.width){let e=s.quality;const t=(c||u.data.duration)-(d||0),i=t/s.duration,l=s.dimensions.width*i,h=Math.min(1,t/u.data.duration),m=r/s.duration*s.dimensions.width;let f=e*l*(1/h);const I=Math.floor(u.data.duration*u.data.sample_rate/f);I<u.data.scale&&(e*=I/u.data.scale,f=e*l*(1/h),console.warn("Selected quality too high, or segment too small",{quality:e,newWidth:f}));try{const t=u.data.resample({width:f});await new Promise((e=>setTimeout(e,0))),a=!0,n.push({...o,waveform:{data:t,atWidth:l,startPixel:m,quality:e,segment:u.segment}})}catch(g){console.error(g)}}else n.push(o);r+=c-d}}a&&t({sequence:n,loadingProgress:0})},async setAttributes(e,n,a){const r=[],o={isLoading:!0},l=[];if(void 0!==e.duration){const t=parseFloat(e.duration);Number.isNaN(t)||(o.duration=t)}if(void 0!==e["current-time"]&&(o.currentTime=Number(e["current-time"])),void 0!==e.srcset){const t=function(e){const t=[];if(-1===e.indexOf("#")&&-1!==e.indexOf(",")){const i=s(e,",");for(const e of i){const[i,n=i]=s(e," ");n&&i&&t.push({id:n,waveform:i,data:null})}}else{const i=s(e,"|");for(const e of i){const[i,n]=s(e," "),a={id:n,waveform:i,data:null};if(n&&-1!==n.indexOf("#t=")){const[e,t]=s(n,"#t="),[i,r]=s(t,","),o=parseFloat(i),l=parseFloat(r);Number.isNaN(o)||Number.isNaN(l)||(a.segment={start:o,end:l,id:n},a.id=e,a.duration=l-o)}n&&i&&t.push(a)}}return t}(e.srcset);for(const e of t)A[e.id]=A[e.id]?A[e.id]:[],A[e.id].push((()=>this.fetchWaveform(e.waveform)));o.sources=t}else if(void 0!==e.src){const[i,n=i]=s(e.src," ");i&&(o.sources=[{id:n,waveform:i,data:null,duration:-1}],r.push(this.fetchWaveform(i).then((e=>{t((t=>t.duration?{}:{duration:e.duration}))}))))}if(void 0!==e.quality){const t=parseFloat(e.quality);t&&!Number.isNaN(t)&&(o.quality=t)}if(void 0!==e.sequence){const t=[],i=s(e.sequence,"|");let n=0;for(const e of i){const[i,a]=s(e,"#t="),[o,h]=s(a,","),g=A[i];g&&!l.includes(i)&&(l.push(i),r.push(...g.map((e=>e()))),A[i]=null);const u=parseFloat(o),d=parseFloat(h);n+=d-u,t.push({startTime:u,endTime:d,id:i,source:e.replace(/[#,:.\n]/g,"__").trim(),waveform:null})}o.duration=n,o.sequence=t}if(t(o),(o.sources||o.sequence||o.quality)&&!n&&await i().resize(a),r.length){try{await Promise.all(r)}catch(h){console.error(h)}return t({isLoading:!1}),void(await i().resize(a))}t({isLoading:!1})}})));var i}function w(e,t,s=128){0===s&&(s=1);return t-(e+s/2)*t/s}function _(e,t){const s=document.createElementNS("http://www.w3.org/2000/svg",e);for(const i of Object.keys(t)){const e=t[i];s.setAttributeNS(null,i,e)}return s}class y extends HTMLElement{constructor(){super(),__publicField(this,"store"),__publicField(this,"hasInitialised",!1),__publicField(this,"initialAttributes",{}),__publicField(this,"unsubscribe"),__publicField(this,"invalidation",{dimensions:!1,sequence:!1}),__publicField(this,"svg"),__publicField(this,"svgParts"),__publicField(this,"buffered"),__publicField(this,"waveformCache",{}),__publicField(this,"lastBufferedStarts",[]),__publicField(this,"lastWidth",-1),__publicField(this,"lastHeight",-1),__publicField(this,"resizeTimout",-1),__publicField(this,"requeueResize",!1),__publicField(this,"resize",(()=>{-1===this.resizeTimout&&(this.resizeTimout=setTimeout(this.forceResize,0))})),__publicField(this,"isAlreadyResizing",!1),__publicField(this,"forceResize",(()=>{this.resizeTimout=-1;const e=this.getBoundingClientRect(),t=window.devicePixelRatio||1;this.store.getState().setDimensions(e,t);const{width:s,height:i}=this.getBoundingClientRect();if(this.lastWidth=s,this.lastHeight=i,this.svg.setAttributeNS(null,"height",`${i}px`),this.svg.setAttributeNS(null,"width","100%"),this.svg.setAttributeNS(null,"preserveAspectRatio","none"),this.svg.setAttributeNS(null,"viewBox",`0 0 ${s} ${i}`),this.hasInitialised){if(this.isAlreadyResizing)return void(this.requeueResize=!0);this.isAlreadyResizing=!0,this.setIsLoading(!0),this.store.getState().resize((()=>this.requeueResize)).then((()=>{this.setIsLoading(!1),this.resizeTimout=-1,this.isAlreadyResizing=!1,this.requeueResize&&(this.resize(),this.requeueResize=!1)}))}})),__publicField(this,"attributeQueue",{}),__publicField(this,"attributeTimeout",-1),__publicField(this,"isAlreadyUpdating",!1),__publicField(this,"requeueUpdate",!1),__publicField(this,"windowEvent",!1),this.attachShadow({mode:"open"});const e=document.createElement("style");e.innerHTML="\n        :host {\n            display: block;\n            --waveform-background: #000;\n            --waveform-base: #8a9aa1;\n            --waveform-hover: #14a4c3;\n            --waveform-buffered: #fff;\n            --waveform-progress: rgba(255, 255, 255, .4);\n        }\n\n        svg {\n            background: var(--waveform-background, #000);\n        }\n\n        svg .waveforms {\n            transition: opacity 140ms;\n        }\n\n        svg rect.hover {\n            fill: var(--waveform-hover, #14a4c3);\n        }\n\n        svg rect.base {\n            fill: var(--waveform-base, #8a9aa1);\n        }\n\n        svg rect.progress {\n            fill: var(--waveform-progress, #14a4c3);\n        }\n\n        svg .buffered rect {\n            fill: var(--waveform-buffered, #fff);\n        }\n\n        svg .loading {\n            translate: 0px -0.5px;\n        }\n    ",this.store=C({}),this.createEmptySVG(),this.shadowRoot.appendChild(this.svg),this.shadowRoot.appendChild(e);const t=this.render.bind(this);this.unsubscribe=this.store.subscribe(((e,s)=>{e.sequence!==s.sequence&&(this.invalidation.sequence=!0),e.isLoading!==s.isLoading&&this.setIsLoading(e.isLoading),e.loadingProgress!==s.loadingProgress&&this.svgParts.loading&&(this.svgParts.loading.style.width=100*e.loadingProgress+"%"),e.dimensions!==s.dimensions&&(this.invalidation.dimensions=!0),requestAnimationFrame(t)}))}set currentTime(e){this.store.setState({currentTime:e})}get currentTime(){return this.store.getState().currentTime}get duration(){return this.store.getState().duration}get quality(){return this.store.getState().quality}reseek(e){e&&(this.buffered=e),this.buffered}createEmptySVG(){this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.setAttribute("xmlns","http://www.w3.org/2000/svg"),this.svg.style.background="var(--waveform-background, #000)";const e=(Math.random()+1).toString(36).substring(2);this.svgParts={loading:_("rect",{x:"0",y:"50%",width:"",height:"1",fill:"#fff",class:"loading"}),mask:_("mask",{id:"waveform-"+e}),waveforms:_("g",{class:"waveforms"}),maskBg:_("rect",{x:"0",y:"0",width:`${this.store.getState().dimensions.width}px`,height:"100%",fill:"#000"}),base:_("rect",{class:"base",mask:"url(#waveform-"+e+")",x:"0px",y:"0px",width:"100%",height:"100%"}),progress:_("rect",{class:"progress",mask:"url(#waveform-"+e+")",x:"0px",y:"0px",width:"0px",height:"100%"}),hover:_("rect",{class:"hover",mask:"url(#waveform-"+e+")",x:"0px",y:"0px",height:"100%"}),buffered:_("g",{class:"buffered"}),line:_("line",{class:"waveform-line",x1:"0px",stroke:"#999"})},this.svgParts.mask.appendChild(this.svgParts.maskBg),this.svgParts.mask.appendChild(this.svgParts.waveforms),this.svgParts.waveforms.appendChild(this.svgParts.line);const t=_("defs",{});t.appendChild(this.svgParts.mask),this.svg.appendChild(t),this.svg.appendChild(this.svgParts.base),this.svg.appendChild(this.svgParts.buffered),this.svg.appendChild(this.svgParts.hover),this.svg.appendChild(this.svgParts.progress),this.svg.appendChild(this.svgParts.loading)}resizeSVG(){const e=this.store.getState().dimensions;this.svgParts.maskBg.setAttributeNS(null,"width",`${e.width}px`),this.svgParts.base.setAttributeNS(null,"height",`${e.height}px`),this.svgParts.progress.setAttributeNS(null,"height",`${e.height}px`),this.svgParts.hover.setAttributeNS(null,"height",`${e.height}px`),this.svgParts.line.setAttributeNS(null,"x2",`${e.width}px`),this.svgParts.line.setAttributeNS(null,"y1",e.height/2+"px"),this.svgParts.line.setAttributeNS(null,"y2",e.height/2+"px")}addSequenceToSVG(e){if(!e.waveform)return;const t=this.svgParts.waveforms.querySelector(`[data-sequence="${e.source}"]`),s=e.waveform.data,i=s.channel(0),n=e.waveform.segment?e.startTime-e.waveform.segment.start:e.startTime;let a=e.waveform.segment?e.endTime-e.waveform.segment.start:e.endTime;a>s.duration&&(console.warn("Data does not match waveform duration",{overflow:a-s.duration}),a=s.duration-.01);const r=~~(s.pixels_per_second*n),o=r+~~(s.pixels_per_second*(a-n)),l=this.store.getState().dimensions.height,h=[];let g,u=!1;const d=[],c=[];for(let p=r;p<o;p++)try{const e=i.max_sample(p);Number.isSafeInteger(e)&&(d[p]=e)}catch(b){g=b,u=!0}for(let p=o;p>=r;p--)try{const e=i.min_sample(p);Number.isSafeInteger(e)&&(c[p]=e)}catch(b){g=b,u=!0}if(0===d.length||0===c.length)return;const m=2.5*Math.max(0,...d.filter((e=>void 0!==e))),f=2.5*Math.abs(Math.min(...c.filter((e=>void 0!==e))));for(let p=r;p<o;p++){const t=d[p];if(void 0!==t){const s=(p-r)/(e.waveform.quality||1);h.push([e.waveform.startPixel+(0===s?-2:s+.5),w(t,l,m+1)+.5])}}for(let p=o;p>=r;p--){const t=c[p];if(void 0!==t){const s=(p-r)/(e.waveform.quality||1);h.push([e.waveform.startPixel+(0===s?-2:s+.5),w(t,l,f+1)+.5])}}u&&(g&&console.error(g),console.error("Error rendering waveform",i,e),console.log("Debug component",this.outerHTML));const I=h.map((e=>e.join(","))).join(" ");if(t)t.setAttributeNS(null,"points",I);else{const t=_("polygon",{points:I,fill:"#fff","data-sequence":e.source});this.svgParts.waveforms.appendChild(t)}}removeSequenceFromSVG(e){var t;const s=this.svgParts.waveforms.querySelector(`[data-sequence="${e}"]`);s&&(null==(t=s.parentNode)||t.removeChild(s))}render(){const{isLoading:e,sources:t,currentTime:s,sequence:i,dimensions:n,hoverTime:a,duration:r,mouse:o}=this.store.getState();if(this.invalidation.dimensions&&(this.resizeSVG(),this.reseek(),this.invalidation.dimensions=!1),this.invalidation.sequence){const e=i.map((e=>e.source));for(const t of[...this.svgParts.waveforms.children]){const s=t.getAttribute("data-sequence");e.includes(s)||this.removeSequenceFromSVG(s)}for(const t of i)this.addSequenceToSVG(t);this.invalidation.sequence=!1}if(e)return;const l=o.isHover?Math.abs(~~(n.width/r*a)):0,h=Math.abs(~~(n.width/r*s));this.svgParts.hover.setAttributeNS(null,"width",`${l}px`),this.svgParts.base.setAttributeNS(null,"x",`${l}px`),this.svgParts.progress.setAttributeNS(null,"width",`${h}px`)}static get observedAttributes(){return["src","srcset","duration","quality","sequence","current-time","resize"]}setIsLoading(e){this.svgParts.waveforms.style.opacity=""+(e?0:1)}connectedCallback(){if(this.isConnected){"true"===this.initialAttributes.resize&&(this.windowEvent=!0,window.addEventListener("resize",this.resize)),this.store.getState().setAttributes(this.initialAttributes,!0,(()=>!1)).then((()=>{})),this.initialAttributes={},this.resize(),this.hasInitialised=!0;const e={x:0,y:0,moved:!1};this.addEventListener("touchstart",(t=>{t.preventDefault();const{dimensions:s}=this.store.getState();this.store.setState({pointer:{isDown:!0}}),e.x=t.touches[0].pageX-s.pageX,e.y=t.touches[0].pageY-s.pageY,this.store.getState().setHover(e.x)})),this.addEventListener("touchmove",(t=>{if(this.store.getState().pointer.isDown&&t.touches.length){t.preventDefault();const{dimensions:s}=this.store.getState();e.x=t.touches[0].pageX-s.pageX,e.y=t.touches[0].pageY-s.pageY,e.moved=!0,this.store.getState().setHover(e.x)}})),this.addEventListener("touchend",(t=>{t.preventDefault(),this.store.getState().pointer.isDown&&(this.store.setState({pointer:{isDown:!1}}),this.moveToPoint(e,!0),e.moved=!1)})),this.addEventListener("click",(e=>{e.preventDefault();const{dimensions:t}=this.store.getState(),s={x:e.pageX-t.pageX,y:e.pageY-t.pageY};this.moveToPoint(s,!0)})),this.addEventListener("mousemove",(e=>{const{dimensions:t}=this.store.getState(),s={x:e.pageX-t.pageX,y:e.pageY-t.pageY};this.store.getState().setHover(s.x)})),this.addEventListener("pointerenter",(e=>{this.store.setState((e=>({mouse:{...e.mouse,isHover:!0}})))})),this.addEventListener("pointerleave",(e=>{this.store.setState((e=>({mouse:{...e.mouse,isHover:!1}})))})),this.addEventListener("pointerdown",(e=>{this.store.setState((e=>({mouse:{...e.mouse,isActive:!0}})))})),this.addEventListener("pointerup",(e=>{this.store.setState((e=>({mouse:{...e.mouse,isActive:!1}})))}))}}moveToPoint(e,t=!1){this.store.setState((s=>{const i=Math.abs(e.x)/s.dimensions.width,n=s.duration*i;let a,r=0;for(const e of s.sequence){if(a=e,n<r+e.endTime-e.startTime)break;r+=e.endTime-e.startTime}if(t){if(!this.dispatchEvent(new CustomEvent("click-waveform",{detail:{time:n,percent:i,target:e,currentSequence:a,sequenceTime:n-r},cancelable:!0,bubbles:!0})))return{}}return this.setAttribute("current-time",`${n}`),{currentTime:n}}))}attributeChangedCallback(e,t,s){this.hasInitialised?(this.attributeQueue[e]=s,this.queueUpdate()):this.initialAttributes[e]=s}queueUpdate(){-1===this.attributeTimeout&&(this.attributeTimeout=setTimeout(this.updateAttributes.bind(this),10)),this.requeueUpdate=!1}updateAttributes(){this.attributeTimeout=-1,this.isAlreadyUpdating?this.requeueUpdate=!0:this.hasInitialised&&(this.isAlreadyUpdating=!0,this.setIsLoading(!0),this.store.getState().setAttributes(this.attributeQueue,!1,(()=>this.requeueUpdate)).then((()=>{this.setIsLoading(!1),this.isAlreadyUpdating=!1,this.requeueUpdate&&this.queueUpdate()})),this.attributeQueue={})}disconnectedCallback(){this.unsubscribe(),this.windowEvent&&window.removeEventListener("resize",this.resize)}}customElements.define("waveform-panel",y),console.log("<waveform-panel /> version v1.2.0"),e.WaveformPanel=y,Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})}));
//# sourceMappingURL=index.umd.js.map
