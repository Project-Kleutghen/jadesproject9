"use strict";var e=Object.defineProperty,t=(t,s,i)=>(((t,s,i)=>{s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[s]=i})(t,"symbol"!=typeof s?s+"":s,i),i);Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const s=require("zustand/vanilla"),i=require("waveform-data"),r=e=>e&&"object"==typeof e&&"default"in e?e:{default:e},n=r(s),a=r(i);function o(e,t){const s=(e||"").replace(/\n/,"").trim();return void 0!==t?s.split(t):s}const h={};function u(e){return n.default()(((t,s,i)=>({sources:[],sequence:[],...e,duration:0,currentTime:0,hoverTime:0,quality:1,bufferedSlices:[],waveforms:[],dimensions:{pageX:0,pageY:0,height:0,width:0,dpi:0},isLoading:!0,pointer:{isDown:!1},mouse:{isHover:!1,isActive:!1},setDimensions(e,s=0){t({dimensions:{width:e.width,height:e.height,pageY:e.y,pageX:e.x,dpi:s}})},setHover(e){t((t=>{const s=Math.abs(e)/t.dimensions.width;return{hoverTime:t.duration*s}}))},async fetchWaveform(e){if(e)return fetch(e).then((e=>e.arrayBuffer())).then((e=>async function(e){return a.default.create(e)}(e))).then((s=>(t((t=>({sources:(t.sources||[]).map((t=>t.waveform===e?{...t,duration:s.duration,data:s}:t))}))),s)))},resize:async function(e){const i=s(),r=[];let n=!1,a=0;const o=i.sequence&&0!==i.sequence.length?i.sequence:(i.sources||[]).map(((e,t)=>({startTime:e.segment?e.segment.start:0,endTime:e.segment?e.segment.end:i.duration,id:e.id,source:e.id+t,waveform:null}))),h=[];for(let t of o){const e=(i.sources||[]).filter((e=>{if(e.id===t.id){if(e.segment){const s=e.segment;return t.endTime>s.start&&t.startTime<s.end}return!0}return!1}));if(e.length>1){const s=t;for(let t=0;t<e.length;t++){const i=e[t],r=i.segment?Math.max(s.startTime,i.segment.start):s.startTime,n=i.segment?Math.min(s.endTime,i.segment.end):s.endTime;h.push({...s,source:s.id+"__"+r+"__"+n,startTime:r,endTime:n})}}else h.push(t)}let u=h.length;for(let s=0;s<h.length;s++){let o=h[s];if(e())return;t({loadingProgress:s/u});const l=(i.sources||[]).find((e=>!(e.id!==o.id)&&(!e.segment||o.startTime>=e.segment.start&&o.endTime<=e.segment.end))),c=l.segment?o.startTime-l.segment.start:o.startTime,m=l.segment?o.endTime-l.segment.start:o.endTime;if(!(m-c<=0)){if(l&&l.data&&i.dimensions.width){let e=i.quality;const t=(m||l.data.duration)-(c||0),s=t/i.duration,h=i.dimensions.width*s,u=Math.min(1,t/l.data.duration),g=a/i.duration*i.dimensions.width;let v=e*h*(1/u);const f=Math.floor(l.data.duration*l.data.sample_rate/v);f<l.data.scale&&(e*=f/l.data.scale,v=e*h*(1/u),console.warn("Selected quality too high, or segment too small",{quality:e,newWidth:v}));try{const t=l.data.resample({width:v});await new Promise((e=>setTimeout(e,0))),n=!0,r.push({...o,waveform:{data:t,atWidth:h,startPixel:g,quality:e,segment:l.segment}})}catch(d){console.error(d)}}else r.push(o);a+=m-c}}n&&t({sequence:r,loadingProgress:0})},async setAttributes(e,i,r){const n=[],a={isLoading:!0},u=[];if(void 0!==e.duration){const t=parseFloat(e.duration);Number.isNaN(t)||(a.duration=t)}if(void 0!==e["current-time"]&&(a.currentTime=Number(e["current-time"])),void 0!==e.srcset){const t=function(e){const t=[];if(-1===e.indexOf("#")&&-1!==e.indexOf(",")){const s=o(e,",");for(const e of s){const[s,i=s]=o(e," ");i&&s&&t.push({id:i,waveform:s,data:null})}}else{const s=o(e,"|");for(const e of s){const[s,i]=o(e," "),r={id:i,waveform:s,data:null};if(i&&-1!==i.indexOf("#t=")){const[e,t]=o(i,"#t="),[s,n]=o(t,","),a=parseFloat(s),h=parseFloat(n);Number.isNaN(a)||Number.isNaN(h)||(r.segment={start:a,end:h,id:i},r.id=e,r.duration=h-a)}i&&s&&t.push(r)}}return t}(e.srcset);for(const e of t)h[e.id]=h[e.id]?h[e.id]:[],h[e.id].push((()=>this.fetchWaveform(e.waveform)));a.sources=t}else if(void 0!==e.src){const[s,i=s]=o(e.src," ");s&&(a.sources=[{id:i,waveform:s,data:null,duration:-1}],n.push(this.fetchWaveform(s).then((e=>{t((t=>t.duration?{}:{duration:e.duration}))}))))}if(void 0!==e.quality){const t=parseFloat(e.quality);t&&!Number.isNaN(t)&&(a.quality=t)}if(void 0!==e.sequence){const t=[],s=o(e.sequence,"|");let i=0;for(const e of s){const[s,r]=o(e,"#t="),[a,d]=o(r,","),l=h[s];l&&!u.includes(s)&&(u.push(s),n.push(...l.map((e=>e()))),h[s]=null);const c=parseFloat(a),m=parseFloat(d);i+=m-c,t.push({startTime:c,endTime:m,id:s,source:e.replace(/[#,:.\n]/g,"__").trim(),waveform:null})}a.duration=i,a.sequence=t}if(t(a),(a.sources||a.sequence||a.quality)&&!i&&await s().resize(r),n.length){try{await Promise.all(n)}catch(d){console.error(d)}return t({isLoading:!1}),void(await s().resize(r))}t({isLoading:!1})}})))}function d(e,t,s=128){0===s&&(s=1);return t-(e+s/2)*t/s}function l(e,t){const s=document.createElementNS("http://www.w3.org/2000/svg",e);for(const i of Object.keys(t)){const e=t[i];s.setAttributeNS(null,i,e)}return s}class c extends HTMLElement{constructor(){super(),t(this,"store"),t(this,"hasInitialised",!1),t(this,"initialAttributes",{}),t(this,"unsubscribe"),t(this,"invalidation",{dimensions:!1,sequence:!1}),t(this,"svg"),t(this,"svgParts"),t(this,"buffered"),t(this,"waveformCache",{}),t(this,"lastBufferedStarts",[]),t(this,"lastWidth",-1),t(this,"lastHeight",-1),t(this,"resizeTimout",-1),t(this,"requeueResize",!1),t(this,"resize",(()=>{-1===this.resizeTimout&&(this.resizeTimout=setTimeout(this.forceResize,0))})),t(this,"isAlreadyResizing",!1),t(this,"forceResize",(()=>{this.resizeTimout=-1;const e=this.getBoundingClientRect(),t=window.devicePixelRatio||1;this.store.getState().setDimensions(e,t);const{width:s,height:i}=this.getBoundingClientRect();if(this.lastWidth=s,this.lastHeight=i,this.svg.setAttributeNS(null,"height",`${i}px`),this.svg.setAttributeNS(null,"width","100%"),this.svg.setAttributeNS(null,"preserveAspectRatio","none"),this.svg.setAttributeNS(null,"viewBox",`0 0 ${s} ${i}`),this.hasInitialised){if(this.isAlreadyResizing)return void(this.requeueResize=!0);this.isAlreadyResizing=!0,this.setIsLoading(!0),this.store.getState().resize((()=>this.requeueResize)).then((()=>{this.setIsLoading(!1),this.resizeTimout=-1,this.isAlreadyResizing=!1,this.requeueResize&&(this.resize(),this.requeueResize=!1)}))}})),t(this,"attributeQueue",{}),t(this,"attributeTimeout",-1),t(this,"isAlreadyUpdating",!1),t(this,"requeueUpdate",!1),t(this,"windowEvent",!1),this.attachShadow({mode:"open"});const e=document.createElement("style");e.innerHTML="\n        :host {\n            display: block;\n            --waveform-background: #000;\n            --waveform-base: #8a9aa1;\n            --waveform-hover: #14a4c3;\n            --waveform-buffered: #fff;\n            --waveform-progress: rgba(255, 255, 255, .4);\n        }\n\n        svg {\n            background: var(--waveform-background, #000);\n        }\n\n        svg .waveforms {\n            transition: opacity 140ms;\n        }\n\n        svg rect.hover {\n            fill: var(--waveform-hover, #14a4c3);\n        }\n\n        svg rect.base {\n            fill: var(--waveform-base, #8a9aa1);\n        }\n\n        svg rect.progress {\n            fill: var(--waveform-progress, #14a4c3);\n        }\n\n        svg .buffered rect {\n            fill: var(--waveform-buffered, #fff);\n        }\n\n        svg .loading {\n            translate: 0px -0.5px;\n        }\n    ",this.store=u({}),this.createEmptySVG(),this.shadowRoot.appendChild(this.svg),this.shadowRoot.appendChild(e);const s=this.render.bind(this);this.unsubscribe=this.store.subscribe(((e,t)=>{e.sequence!==t.sequence&&(this.invalidation.sequence=!0),e.isLoading!==t.isLoading&&this.setIsLoading(e.isLoading),e.loadingProgress!==t.loadingProgress&&this.svgParts.loading&&(this.svgParts.loading.style.width=100*e.loadingProgress+"%"),e.dimensions!==t.dimensions&&(this.invalidation.dimensions=!0),requestAnimationFrame(s)}))}set currentTime(e){this.store.setState({currentTime:e})}get currentTime(){return this.store.getState().currentTime}get duration(){return this.store.getState().duration}get quality(){return this.store.getState().quality}reseek(e){e&&(this.buffered=e),this.buffered}createEmptySVG(){this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svg.setAttribute("xmlns","http://www.w3.org/2000/svg"),this.svg.style.background="var(--waveform-background, #000)";const e=(Math.random()+1).toString(36).substring(2);this.svgParts={loading:l("rect",{x:"0",y:"50%",width:"",height:"1",fill:"#fff",class:"loading"}),mask:l("mask",{id:"waveform-"+e}),waveforms:l("g",{class:"waveforms"}),maskBg:l("rect",{x:"0",y:"0",width:`${this.store.getState().dimensions.width}px`,height:"100%",fill:"#000"}),base:l("rect",{class:"base",mask:"url(#waveform-"+e+")",x:"0px",y:"0px",width:"100%",height:"100%"}),progress:l("rect",{class:"progress",mask:"url(#waveform-"+e+")",x:"0px",y:"0px",width:"0px",height:"100%"}),hover:l("rect",{class:"hover",mask:"url(#waveform-"+e+")",x:"0px",y:"0px",height:"100%"}),buffered:l("g",{class:"buffered"}),line:l("line",{class:"waveform-line",x1:"0px",stroke:"#999"})},this.svgParts.mask.appendChild(this.svgParts.maskBg),this.svgParts.mask.appendChild(this.svgParts.waveforms),this.svgParts.waveforms.appendChild(this.svgParts.line);const t=l("defs",{});t.appendChild(this.svgParts.mask),this.svg.appendChild(t),this.svg.appendChild(this.svgParts.base),this.svg.appendChild(this.svgParts.buffered),this.svg.appendChild(this.svgParts.hover),this.svg.appendChild(this.svgParts.progress),this.svg.appendChild(this.svgParts.loading)}resizeSVG(){const e=this.store.getState().dimensions;this.svgParts.maskBg.setAttributeNS(null,"width",`${e.width}px`),this.svgParts.base.setAttributeNS(null,"height",`${e.height}px`),this.svgParts.progress.setAttributeNS(null,"height",`${e.height}px`),this.svgParts.hover.setAttributeNS(null,"height",`${e.height}px`),this.svgParts.line.setAttributeNS(null,"x2",`${e.width}px`),this.svgParts.line.setAttributeNS(null,"y1",e.height/2+"px"),this.svgParts.line.setAttributeNS(null,"y2",e.height/2+"px")}addSequenceToSVG(e){if(!e.waveform)return;const t=this.svgParts.waveforms.querySelector(`[data-sequence="${e.source}"]`),s=e.waveform.data,i=s.channel(0),r=e.waveform.segment?e.startTime-e.waveform.segment.start:e.startTime;let n=e.waveform.segment?e.endTime-e.waveform.segment.start:e.endTime;n>s.duration&&(console.warn("Data does not match waveform duration",{overflow:n-s.duration}),n=s.duration-.01);const a=~~(s.pixels_per_second*r),o=a+~~(s.pixels_per_second*(n-r)),h=this.store.getState().dimensions.height,u=[];let c,m=!1;const g=[],v=[];for(let d=a;d<o;d++)try{const e=i.max_sample(d);Number.isSafeInteger(e)&&(g[d]=e)}catch(b){c=b,m=!0}for(let d=o;d>=a;d--)try{const e=i.min_sample(d);Number.isSafeInteger(e)&&(v[d]=e)}catch(b){c=b,m=!0}if(0===g.length||0===v.length)return;const f=2.5*Math.max(0,...g.filter((e=>void 0!==e))),p=2.5*Math.abs(Math.min(...v.filter((e=>void 0!==e))));for(let l=a;l<o;l++){const t=g[l];if(void 0!==t){const s=(l-a)/(e.waveform.quality||1);u.push([e.waveform.startPixel+(0===s?-2:s+.5),d(t,h,f+1)+.5])}}for(let l=o;l>=a;l--){const t=v[l];if(void 0!==t){const s=(l-a)/(e.waveform.quality||1);u.push([e.waveform.startPixel+(0===s?-2:s+.5),d(t,h,p+1)+.5])}}m&&(c&&console.error(c),console.error("Error rendering waveform",i,e),console.log("Debug component",this.outerHTML));const w=u.map((e=>e.join(","))).join(" ");if(t)t.setAttributeNS(null,"points",w);else{const t=l("polygon",{points:w,fill:"#fff","data-sequence":e.source});this.svgParts.waveforms.appendChild(t)}}removeSequenceFromSVG(e){var t;const s=this.svgParts.waveforms.querySelector(`[data-sequence="${e}"]`);s&&(null==(t=s.parentNode)||t.removeChild(s))}render(){const{isLoading:e,sources:t,currentTime:s,sequence:i,dimensions:r,hoverTime:n,duration:a,mouse:o}=this.store.getState();if(this.invalidation.dimensions&&(this.resizeSVG(),this.reseek(),this.invalidation.dimensions=!1),this.invalidation.sequence){const e=i.map((e=>e.source));for(const t of[...this.svgParts.waveforms.children]){const s=t.getAttribute("data-sequence");e.includes(s)||this.removeSequenceFromSVG(s)}for(const t of i)this.addSequenceToSVG(t);this.invalidation.sequence=!1}if(e)return;const h=o.isHover?Math.abs(~~(r.width/a*n)):0,u=Math.abs(~~(r.width/a*s));this.svgParts.hover.setAttributeNS(null,"width",`${h}px`),this.svgParts.base.setAttributeNS(null,"x",`${h}px`),this.svgParts.progress.setAttributeNS(null,"width",`${u}px`)}static get observedAttributes(){return["src","srcset","duration","quality","sequence","current-time","resize"]}setIsLoading(e){this.svgParts.waveforms.style.opacity=""+(e?0:1)}connectedCallback(){if(this.isConnected){"true"===this.initialAttributes.resize&&(this.windowEvent=!0,window.addEventListener("resize",this.resize)),this.store.getState().setAttributes(this.initialAttributes,!0,(()=>!1)).then((()=>{})),this.initialAttributes={},this.resize(),this.hasInitialised=!0;const e={x:0,y:0,moved:!1};this.addEventListener("touchstart",(t=>{t.preventDefault();const{dimensions:s}=this.store.getState();this.store.setState({pointer:{isDown:!0}}),e.x=t.touches[0].pageX-s.pageX,e.y=t.touches[0].pageY-s.pageY,this.store.getState().setHover(e.x)})),this.addEventListener("touchmove",(t=>{if(this.store.getState().pointer.isDown&&t.touches.length){t.preventDefault();const{dimensions:s}=this.store.getState();e.x=t.touches[0].pageX-s.pageX,e.y=t.touches[0].pageY-s.pageY,e.moved=!0,this.store.getState().setHover(e.x)}})),this.addEventListener("touchend",(t=>{t.preventDefault(),this.store.getState().pointer.isDown&&(this.store.setState({pointer:{isDown:!1}}),this.moveToPoint(e,!0),e.moved=!1)})),this.addEventListener("click",(e=>{e.preventDefault();const{dimensions:t}=this.store.getState(),s={x:e.pageX-t.pageX,y:e.pageY-t.pageY};this.moveToPoint(s,!0)})),this.addEventListener("mousemove",(e=>{const{dimensions:t}=this.store.getState(),s={x:e.pageX-t.pageX,y:e.pageY-t.pageY};this.store.getState().setHover(s.x)})),this.addEventListener("pointerenter",(e=>{this.store.setState((e=>({mouse:{...e.mouse,isHover:!0}})))})),this.addEventListener("pointerleave",(e=>{this.store.setState((e=>({mouse:{...e.mouse,isHover:!1}})))})),this.addEventListener("pointerdown",(e=>{this.store.setState((e=>({mouse:{...e.mouse,isActive:!0}})))})),this.addEventListener("pointerup",(e=>{this.store.setState((e=>({mouse:{...e.mouse,isActive:!1}})))}))}}moveToPoint(e,t=!1){this.store.setState((s=>{const i=Math.abs(e.x)/s.dimensions.width,r=s.duration*i;let n,a=0;for(const e of s.sequence){if(n=e,r<a+e.endTime-e.startTime)break;a+=e.endTime-e.startTime}if(t){if(!this.dispatchEvent(new CustomEvent("click-waveform",{detail:{time:r,percent:i,target:e,currentSequence:n,sequenceTime:r-a},cancelable:!0,bubbles:!0})))return{}}return this.setAttribute("current-time",`${r}`),{currentTime:r}}))}attributeChangedCallback(e,t,s){this.hasInitialised?(this.attributeQueue[e]=s,this.queueUpdate()):this.initialAttributes[e]=s}queueUpdate(){-1===this.attributeTimeout&&(this.attributeTimeout=setTimeout(this.updateAttributes.bind(this),10)),this.requeueUpdate=!1}updateAttributes(){this.attributeTimeout=-1,this.isAlreadyUpdating?this.requeueUpdate=!0:this.hasInitialised&&(this.isAlreadyUpdating=!0,this.setIsLoading(!0),this.store.getState().setAttributes(this.attributeQueue,!1,(()=>this.requeueUpdate)).then((()=>{this.setIsLoading(!1),this.isAlreadyUpdating=!1,this.requeueUpdate&&this.queueUpdate()})),this.attributeQueue={})}disconnectedCallback(){this.unsubscribe(),this.windowEvent&&window.removeEventListener("resize",this.resize)}}customElements.define("waveform-panel",c),console.log("<waveform-panel /> version v1.2.0"),exports.WaveformPanel=c;
//# sourceMappingURL=index.js.map
